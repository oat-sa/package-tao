
function QTIResultCollector(interaction){var _this=this;this.opts=interaction.getAttributes();this.id=interaction.attr('identifier');this.responses=[];this.append=function(data){this.responses.push(data);return this.responses.length-1;}
this.remove=function(responseId){delete this.responses[responseId];}
this.get=function(responseId){return this.responses[responseId];}
this.set=function(response){this.responses=response;}
this.isSet=function(value){var ret=-1;for(var i in this.responses){if(typeof(value)==='object'||typeof(value)==='array'){ret=i;for(var k in value){if(value[k]!=this.responses[i][k]){ret=-1;break;}}}else{if(value==this.responses[i]){ret=i;break;}}}
return ret;}
this.choice=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};$("#"+_this.id+" .tabActive").each(function(){if(_this.opts["maxChoices"]!=1)
result.value.push(this.id);else
result.value=this.id;});return result;};this.order=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":new Object()};var i=0;var listClass=(_this.opts['orientation']=='horizontal')?'qti_choice_list_horizontal':'qti_choice_list';$('#'+_this.id+' ul.'+listClass+' li').each(function(){result.value[i]=this.id;i++;});return result;};this.associate=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxAssociations"]==1)?null:[]};$("#"+_this.id+" .qti_association_pair").each(function(){if(!$(this).find('li:first').find('.filled_pair').length){return;}
var firstId='';if($(this).find('li:first').find('.filled_pair').length>0){firstId=$(this).find('li:first').find('.filled_pair').attr('id').replace('pair_','');}
var lastId='';if($(this).find('li:last').find('.filled_pair').length>0){lastId=$(this).find('li:last').find('.filled_pair').attr('id').replace('pair_','');}
var elt=[firstId,lastId];if(_this.opts["maxAssociations"]==1){result.value=elt;}else if(_this.opts["maxAssociations"]==0||result.value.length<_this.opts["maxAssociations"]){result.value.push(elt);}});return result;};this.text=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":null};if($('#'+this.id).prop('tagName').toLowerCase()!=='div'){switch(_this.opts['baseType']){case"integer":result.value=parseInt($("#"+_this.id).val());break;case"float":result.value=parseFloat($("#"+_this.id).val());break;case"string":default:result.value=$("#"+_this.id).val();}}
else{result.value=new Array();$("#"+_this.id+" :text").each(function(){switch(_this.opts['baseType']){case"integer":result.value.push(parseInt($(this).val()));break;case"float":result.value.push(parseFloat($(this).val()));break;case"string":default:result.value.push($(this).val());}});}
return result;};this.text_entry=this.text;this.extended_text=this.text;this.inline_choice=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":$("#"+_this.id).val()};return result;};this.hottext=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxChoices"]!=1)?[]:null};$("#"+_this.id+" .hottext_choice_on").each(function(){if(_this.opts["maxChoices"]!=1){result.value.push(this.id.replace(/^hottext_choice_/,''));}else{result.value=this.id.replace(/^hottext_choice_/,'');}});return result;};this.gap_match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};$("#"+_this.id+" .filled_gap").each(function(){var choiceId=$(this).attr('id').replace('gap_','');var groupId=$(this).parent().attr('id');result.value.push({0:groupId,1:choiceId});});return result;};this.match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxAssociations"]==1)?null:[]};$("#"+_this.id+" .tabActive").each(function(){var subset=new Object();var classes=$(this).attr('class').split(' ');if(classes.length>0){var i=0;while(i<classes.length){if(/^xnode_/.test(classes[i])){subset[0]=classes[i].replace('xnode_','');}
if(/^ynode_/.test(classes[i])){subset[1]=classes[i].replace('ynode_','');}
i++;}
if(_this.opts["maxAssociations"]==1){result.value=subset;}else if(_this.opts["maxAssociations"]==0||result.value.length<_this.opts["maxAssociations"]){result.value.push(subset);}}});return result;};this.hotspot=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};for(var i in this.responses){if(this.opts.maxChoices==1){result.value=this.responses[i];}else{result.value.push(this.responses[i]);}}
return result;};this.select_point=function(){var result={"identifier":this.opts['responseIdentifier'],"value":[]};for(var i in this.responses){var r=this.responses[i];if(!isNaN(r.x)&&!isNaN(r.y)){result.value.push({'0':r.x,'1':r.y});}}
return result;};this.graphic_order=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};for(var i in this.responses){result.value.push(this.responses[i]);}
return result;};this.graphic_associate=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":(_this.opts["maxAssociations"]==1)?null:[]};var pairs=$("#"+_this.id).data('pairs');for(var i in pairs){if(typeof pairs[i]=='string'){var pair=pairs[i].split(' ');if(pair.length==2){if(_this.opts["maxAssociations"]==1){result.value=pair;}else if(_this.opts["maxAssociations"]==0||result.value.length<_this.opts["maxAssociations"]){result.value.push(pair);}}}}
return result;};this.graphic_gap_match=function(){var result={"identifier":_this.opts['responseIdentifier'],"value":[]};for(var i in this.responses){var r=this.responses[i];if(r.hotspot&&r.gapImg){result.value.push({0:r.hotspot,1:r.gapImg});}}
return result;};this.slider=function(){return{"identifier":_this.opts['responseIdentifier'],"value":parseInt($("#"+_this.id+'_qti_slider_value').val())};};this.upload=function(){var value=0;switch(_this.opts['baseType']){case"float":value=parseFloat($("#"+_this.id+'_data').val());break;case"integer":default:value=parseInt($("#"+_this.id+'_data').val());}
return{"identifier":_this.opts['responseIdentifier'],"value":value};};this.end_attempt=function(){var value=0;if(parseInt($("#"+_this.id+'_data').val())>1){value=1;}
return{"identifier":_this.opts['responseIdentifier'],"value":value};};}
Qti.DefaultRenderer=Qti.Renderer.extend({getRawTemplates:function(){return{'#assessmentItem':['<div id="{{attributes.identifier}}" class="qti_item">','<h1>{{attributes.title}}</h1>','<div class="qti_item_body">{{{body}}}</div>','</div>'],'#prompt':'<p class="prompt">{{{body}}}</p>','#interaction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','{{#prompt}}{{{prompt}}}{{/prompt}}','<ul class="qti_choice_list">','{{#choices}}{{{.}}}{{/choices}}','</ul>','</div>'],'#choiceInteraction':'#interaction','#inlineChoiceInteraction':['<select id="{{attributes.identifier}}" name="{{attributes.identifier}}" class="qti_{{_type}} {{attributes.class}}">','{{#choices}}{{{.}}}{{/choices}}','</select>'],'#orderInteraction':'#interaction','#associateInteraction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','<div class = "qti_{{_type}}_container" >','{{#prompt}}{{{prompt}}}{{/prompt}}','<ul class="qti_choice_list">','{{#choices}}{{{.}}}{{/choices}}','</ul>','{{#body}}<div>{{{body}}}</div>{{/body}}','</div>','</div>'],'#textEntryInteraction':'<input type="text" id="{{attributes.identifier}}" name="{{attributes.identifier}}" class="qti_{{_type}} {{attributes.class}}" />','#extendedTextInteraction':['<div class="qti_widget qti_{{_type}} {{attributes.class}}">','{{#prompt}}{{{prompt}}}{{/prompt}}','{{#multiple}}','<div id="{{attributes.identifier}}">','{{#maxStringLoop}}<input id="{{attributes.identifier}}_{{.}}" name="{{attributes.identifier}}_{{.}}"/><br />{{/maxStringLoop}}','</div>','{{/multiple}}','{{^multiple}}','<textarea id="{{attributes.identifier}}" name="{{attributes.identifier}}"></textarea>','{{/multiple}}','</div>'],'#matchInteraction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','<div class = "qti_{{_type}}_container" >','{{#prompt}}{{{prompt}}}{{/prompt}}','<ul class="choice_list">','{{#matchSet1}}{{{.}}}{{/matchSet1}}','</ul>','<ul class="choice_list">','{{#matchSet2}}{{{.}}}{{/matchSet2}}','</ul>','</div>','</div>'],'#gapMatchInteraction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','<div class = "qti_{{_type}}_container" >','{{#prompt}}{{{prompt}}}{{/prompt}}','<ul class="qti_choice_list">','{{#choices}}{{{.}}}{{/choices}}','</ul>','<div class="qti_flow_container">{{{body}}}</div>','</div>','</div>'],'#hottextInteraction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','{{#prompt}}{{{prompt}}}{{/prompt}}','<div class="qti_flow_container">{{{body}}}</div>','</div>'],'#graphicInteraction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','{{#prompt}}{{{prompt}}}{{/prompt}}','</div>'],'#selectPointInteraction':'#graphicInteraction','#hotspotInteraction':'#graphicInteraction','#graphicOrderInteraction':'#graphicInteraction','#graphicAssociateInteraction':'#graphicInteraction','#graphicGapMatchInteraction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','{{#prompt}}{{{prompt}}}{{/prompt}}','<ul class="qti_graphic_gap_match_spotlist">','{{#gapImgs}}{{{.}}}{{/gapImgs}}','</ul>','</div>'],'#sliderInteraction':'#graphicInteraction','#mediaInteraction':['<div id="{{attributes.identifier}}" class="qti_widget qti_{{_type}} {{attributes.class}}">','{{{prompt}}}','{{{media}}}','</div>'],'#choice':'<li id="{{attributes.identifier}}" class="{{classes}}">{{{body}}}</li>','#simpleChoice':'#choice','#simpleAssociableChoice':'#choice','#hotspotChoice':'#choice','#associableHotspot':'#choice','#gapText':'#choice','#gap':'<span class="gap" id="{{attributes.identifier}}"></span>','#gapImg':['<li id="{{attributes.identifier}}">','<img src="{{object.attributes.data}}"  width="{{object.attributes.width}}" height="{{object.attributes.height}}" alt="{{object.attributes._alt}}"/>','</li>'],'#hottext':'<span class="hottext_choice hottext_choice_off {{attributes.class}}" id="hottext_choice_{{attributes.identifier}}">{{{body}}}</span>','#inlineChoice':'<option value="{{attributes.identifier}}" class="{{attributes.class}}">{{{body}}}</option>','#object':['{{#video}}<video id="{{serial}}" src="{{attributes.data}}" type="{{attributes.type}}" {{#attributes.width}}width="{{attributes.width}}"{{/attributes.width}} {{#attributes.height}}height="{{attributes.height}}{{/attributes.height}}" controls="controls" preload="none"></video>{{/video}}','{{#audio}}<audio id="{{serial}}" src="{{attributes.data}}" type="{{attributes.type}}"></audio>{{/audio}}','{{#object}}<object id="{{serial}}" src="{{attributes.data}}" type="{{attributes.type}}" width="{{attributes.width}}" height="{{attributes.height}}">{{attributes.alt}}</object>{{/object}}',],'#math':'<math id="{{serial}}" {{#block}}display = "block"{{/block}}>{{{body}}}</math>','#modalFeedback':'<div id="{{serial}}" title="{{attributes.title}}" class="qti-modal-feedback">{{{body}}}</div>'}},getPostRenderers:function(){return{'#interaction':function(interaction,data){var wwwPath='';if(typeof(qti_base_www)!=='undefined'){wwwPath=qti_base_www;if(!/\/$/.test(wwwPath)&&wwwPath!=''){wwwPath+='/';}}
var pluginPath='';if(typeof(qti_plugin_path)!=='undefined'){pluginPath=qti_plugin_path;}
var graphicDebug=false;if(typeof(qti_debug)!=='undefined'){graphicDebug=qti_debug;}
var interactionName=interaction.qtiTag.charAt(0).toUpperCase()+interaction.qtiTag.slice(1);if(typeof(qti_debug)!=='undefined'){if(!QtiWidget||!QtiWidget.DefaultWidget||!QtiWidget.DefaultWidget[interactionName]){alert("Error: Unknow widget "+interactionName);}}
var context={'wwwPath':wwwPath,'graphicDebug':graphicDebug,'pluginPath':pluginPath};interaction.widget=new QtiWidget.DefaultWidget[interactionName](interaction,context);interaction.widget.render();},'#associateInteraction':'#interaction','#choiceInteraction':'#interaction','#endAttemptInteraction':'#interaction','#extendedTextInteraction':'#interaction','#gapMatchInteraction':'#interaction','#graphicAssociateInteraction':'#interaction','#graphicGapMatchInteraction':'#interaction','#graphicOrderInteraction':'#interaction','#hotspotInteraction':'#interaction','#hottextInteraction':'#interaction','#inlineChoiceInteraction':'#interaction','#matchInteraction':'#interaction','#mediaInteraction':'#interaction','#orderInteraction':'#interaction','#selectPointInteraction':'#interaction','#sliderInteraction':'#interaction','#textEntryInteraction':'#interaction','#uploadInteraction':'#interaction','#object':function(object,data){var pluginPath='';if(typeof(qti_plugin_path)!=='undefined'){pluginPath=qti_plugin_path;}
var context={'pluginPath':pluginPath}
object.widget=new QtiWidget.DefaultWidget.Object(object,context);object.widget.render();},'#math':function(math,data){var $mathElt=$('#'+math.serial);if(typeof(MathJax)!=='undefined'&&MathJax){MathJax.Hub.Queue(["Typeset",MathJax.Hub,$mathElt.parent()[0]]);}},'#modalFeedback':function(feedback,data){$('#'+feedback.getSerial()).dialog({modal:true,width:400,height:300,buttons:[{text:'Close',click:function(){$(this).dialog('close');}}],open:function(){feedback.getBody().postRender(feedback.getRenderer());},close:function(){$(this).empty();if(typeof(data.callback)==='function'){data.callback();}}});}}},setResponse:function(interaction,response){if(response!==null&&typeof(response)!=='undefined'){return interaction.widget.setResponse(response);}},getResponse:function(interaction){return interaction.widget.getResponse();}});
QtiWidget={};QtiWidget.DefaultWidget={};QtiWidget.DefaultWidget.Widget=Class.extend({init:function(interaction,context){this.id=interaction.attr('identifier');this.options=interaction.getAttributes();if(context){this.wwwPath=context.wwwPath||'';this.graphicDebug=context.graphicDebug||false;}
var respDecl=interaction.getResponseDeclaration();if(respDecl){this.options.responseBaseType=respDecl.attr('baseType');}
this.resultCollector=new QTIResultCollector(interaction);},render:function(){throw'method to be implemented by inherited widget';},setResponse:function(){throw'method to be implemented by inherited widget';},getResponse:function(){throw'method to be implemented by inherited widget';}});QtiWidget.DefaultWidget.getShapeCenter=function(raphaelShape){var box=raphaelShape.getBBox();return{x:box.x+(box.width/2),y:box.y+(box.height/2)}};QtiWidget.DefaultWidget.polyCoordonates=function(path){var pathArray=[];if(typeof(path)==='string'){pathArray=path.split(",");}else if(typeof(path)==='array'){pathArray=path;}else if(typeof(path)==='object'){for(var i in path){pathArray.push(path[i]);}}else{throw'invalid argument type for path : '+typeof(path);}
var pathArrayLength=pathArray.length;if((pathArray[0]!==pathArray[pathArrayLength-2])&&(pathArray[1]!==pathArray[pathArrayLength-1])){pathArray.push(pathArray[0]);pathArray.push(pathArray[1]);}
pathArray[0]="M"+pathArray[0];for(var a=1;a<pathArrayLength;a++){if(QtiWidget.DefaultWidget.isPair(a)){pathArray[a]="L"+pathArray[a];}}
return pathArray.join(" ");};QtiWidget.DefaultWidget.isPair=function(number){return(!number%2);};QtiWidget.DefaultWidget.setDeactivatedShapeAttr=function(raphaelShape,animationDuration){if(raphaelShape&&raphaelShape.animate){raphaelShape.animate({'fill':'#E0DCDD','fill-opacity':.3,'stroke-opacity':.8,'stroke':'#ABA9AA'},(animationDuration)?animationDuration:100);}};QtiWidget.DefaultWidget.setActivatedShapeAttr=function(raphaelShape){if(raphaelShape&&raphaelShape.animate){raphaelShape.animate({'fill':'green','fill-opacity':.2,'stroke-opacity':.5,'stroke':'green'},100);}};QtiWidget.DefaultWidget.setForbiddenShapeAttr=function(raphaelShape){if(raphaelShape&&raphaelShape.attr){raphaelShape.animate({'fill':'red','fill-opacity':.2,'stroke-opacity':.5,'stroke':'red'},100);}};QtiWidget.DefaultWidget.animateForbiddenShape=function(raphaelShape){QtiWidget.DefaultWidget.setForbiddenShapeAttr(raphaelShape);setTimeout(function(){QtiWidget.DefaultWidget.setDeactivatedShapeAttr(raphaelShape,400);},400);};QtiWidget.DefaultWidget.animateAllowedShape=function(raphaelShape){QtiWidget.DefaultWidget.setActivatedShapeAttr(raphaelShape);setTimeout(function(){QtiWidget.DefaultWidget.setDeactivatedShapeAttr(raphaelShape,400);},400);};
QtiWidget.DefaultWidget.Object=Class.extend({init:function(object,context){this.playCounter=0;this.mediaType=object.getMediaType();if(this.mediaType==='video'||this.mediaType==='audio'){var _this=this;this.playerOptions={loop:false,maxPlays:0,autostart:false,pauseOtherPlayers:false,features:['playpause','current','duration','progress','volume'],pluginPath:'',audioWidth:300,};var width=parseInt(object.attr('width'));if(width>10){if(this.mediaType==='video'){this.playerOptions.videoWidth=width;}else{this.playerOptions.audioWidth=width;}}
var height=parseInt(object.attr('height'));if(height>10){if(this.mediaType==='video'){this.playerOptions.videoHeight=height;}else{this.playerOptions.audioHeight=height;}}
this.id=object.getSerial();this.media=null;if(context){this.pluginPath=context.pluginPath||'';if(this.pluginPath){this.playerOptions.pluginPath=this.pluginPath;}
if(typeof(context.playerOptions)==='object'){this.playerOptions=$.extend(this.playerOptions,context.playerOptions);var successCallback=(typeof(context.playerOptions.success)==='function')?context.playerOptions.success:function(){};this.playerOptions.success=function(mediaElement,domObject){setTimeout(function(){var controlMaxPlays=function(){if(_this.playerOptions.maxPlays&&_this.playCounter>=_this.playerOptions.maxPlays){_this.stop();}};mediaElement.addEventListener('ended',function(e){_this.playCounter++;controlMaxPlays();},false);mediaElement.addEventListener('play',controlMaxPlays);mediaElement.addEventListener('pause',function(){});if(_this.playerOptions.autostart){mediaElement.play();setTimeout(function(){$(domObject).parent('div.mejs-mediaelement').siblings('div.mejs-layers').find('div.mejs-overlay-button').click().mousedown();},1000);}
successCallback(mediaElement,domObject);},300);};}}}},render:function(){if(this.mediaType==='video'||this.mediaType==='audio'){this.media=new MediaElementPlayer('#'+this.id,this.playerOptions);}},playCount:function(count){if(isNaN(count)){return this.playCounter;}else{this.playCounter=count;}},pause:function(){this.media.pause();},stop:function(){this.pause();$('#'+this.id).parent('div.mejs-mediaelement').siblings('div.mejs-layers').find('div.mejs-overlay-button').hide();}});
QtiWidget.DefaultWidget.StringInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){if(this.options['patternMask']){var pattern=new RegExp("^"+this.options['patternMask']+"$");$('#'+this.id).keyup(function(){$(this).removeClass('field-error');if(!pattern.test($(this).val())){$(this).addClass('field-error');}});}
if(this.options['stringIdentifier']){$('#'+this.id).after("<input type='hidden' id='"+this.options['stringIdentifier']+"' />");$("#"+this.options['stringIdentifier']).addClass('qti_text_entry_interaction');$('#'+this.id).change(function(){$("#"+this.options['stringIdentifier']).val($(this).val());});}},setResponse:function(values){var value=values;if(typeof(value)==='string'&&value!=''){$('#'+this.id).val(value);}},getResponse:function(){return this.resultCollector.text();}});
QtiWidget.DefaultWidget.GraphicInteraction=QtiWidget.DefaultWidget.Widget.extend({init:function(interaction,context){this._super(interaction,context);var imgUrl=interaction.object.attr('data');if(!imgUrl.match(/^http/i)){imgUrl=this.wwwPath+imgUrl;}
this.options.imagePath=imgUrl;this.options.imageWidth=interaction.object.attr('width');this.options.imageHeight=interaction.object.attr('height');this.options.graphicChoices={}
var choices=interaction.getChoices();for(var i in choices){this.options.graphicChoices[choices[i].id()]={'shape':choices[i].attr('shape'),'coords':choices[i].attr('coords')}}},buildShape:function(shape,coords){var raphaelShape=null;if(this.paper){switch(shape){case"circle":var x=Number(coords[0]);var y=Number(coords[1]);var size=coords[2];raphaelShape=this.paper[shape](x,y,size);if(this.graphicDebug)
raphaelShape.attr("stroke-width","3px");break;case"rect":var topX=Number(coords[0]);var topY=Number(coords[1]);var bottomX=coords[2]-topX;var bottomY=coords[3]-topY;raphaelShape=this.paper[shape](topX,topY,bottomX,bottomY);if(this.graphicDebug)
raphaelShape.attr("stroke-width","3px");break;case"ellipse":var x=Number(coords[0]);var y=Number(coords[1]);var hRadius=coords[2];var vRadius=coords[3];raphaelShape=this.paper[shape](x,y,hRadius,vRadius);if(this.graphicDebug)
raphaelShape.attr("stroke-width","3px");break;case"poly":var polyCoords=QtiWidget.DefaultWidget.polyCoordonates(coords);raphaelShape=this.paper["path"](polyCoords);if(this.graphicDebug)
raphaelShape.attr("stroke-width","3px");break;}}else{throw'cannot build shape if the raphael paper has not been initialized in this.paper';}
return raphaelShape;}});
QtiWidget.DefaultWidget.AssociateInteraction=QtiWidget.DefaultWidget.Widget.extend({init:function(interaction,context){this._super(interaction,context);this.options.matchMaxes={};for(var i in interaction.choices){var choice=interaction.choices[i];this.options.matchMaxes[choice.attr('identifier')]={'matchMax':parseInt(choice.attr('matchMax')),'matchGroup':[],current:0}}},render:function(){var ctx=this;$('#'+ctx.id+" .qti_choice_list li").wrapInner("<div></div>");var listHeight=parseInt($('#'+ctx.id+" .qti_associate_interaction_container").height());var liMaxHeight=0;var maxBoxSize=0;var calculateSizes=function($choice){if($choice.width()>maxBoxSize){maxBoxSize=$choice.width();}
var liHeight=parseInt($choice.height());if(liHeight>liMaxHeight){liMaxHeight=liHeight;}
if(liHeight>listHeight){listHeight=liHeight+10;}}
var updateSizes=function(){$('#'+ctx.id+" .qti_associate_interaction_container .qti_choice_list").height(listHeight+10);$('#'+ctx.id+" .qti_association_pair li").width(maxBoxSize+4);var pairBoxWidth=0;$('#'+ctx.id+" .qti_association_pair:first li").each(function(){pairBoxWidth+=$(this).width();});$('#'+ctx.id+" .qti_pair_container").css({position:"relative",width:((pairBoxWidth+20)*2)+30,margin:"0 auto 0 auto",top:"10px"});$('#'+ctx.id+" .qti_association_pair").width(pairBoxWidth+90);$('#'+ctx.id+" .qti_association_pair li").height(liMaxHeight);$('#'+ctx.id+" .qti_link_associate").remove();$.each($('#'+ctx.id+" .qti_association_pair"),function(index,elt){$(elt).after("<div class='qti_link_associate'></div>");$('#'+ctx.id+" .qti_link_associate:last").css("top",$(this).position().top+25);$('#'+ctx.id+" .qti_link_associate:last").css("left",maxBoxSize+33);});$('#'+ctx.id).height(($('#'+ctx.id+" .qti_association_pair:last").offset().top-$('#'+ctx.id).offset().top)+liMaxHeight);}
var pairSize=(ctx.options["maxAssociations"]>0)?ctx.options["maxAssociations"]:parseInt($('#'+ctx.id+" .qti_choice_list li").length/2);var pairContainer=$("<div class='qti_pair_container'></div>");for(var a=1;a<=pairSize;a++){var currentPairName=ctx.id+"_"+a;pairContainer.append("<ul class='qti_association_pair' id='"+currentPairName+"'><li id='"+currentPairName+"_A"+"'></li><li id='"+currentPairName+"_B"+"'></li></ul>");}
$('#'+ctx.id+" .qti_associate_interaction_container").after(pairContainer);$('#'+ctx.id+" ul.qti_choice_list li > div").each(function(){var $choice=$(this);$(function(){calculateSizes($choice);updateSizes();});$choice.find('img').load(function(){calculateSizes($choice);updateSizes();});});$('#'+ctx.id+" .qti_associate_interaction_container .qti_choice_list li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},containment:'#'+ctx.id,cursor:"move",revert:true});$('#'+ctx.id+" .qti_association_pair li").droppable({drop:function(event,ui){var draggedId=$(ui.draggable).parents().attr('id');if($(this).find("#pair_"+draggedId).length>0||/^pair_/.test($(ui.draggable).attr('id'))){return false;}
var _matchGroup=ctx.options["matchMaxes"][draggedId]["matchGroup"];if(/A$/.test($(this).attr('id'))){var opposite=$('#'+$(this).attr('id').replace(/_A$/,"_B")).find('.filled_pair:first');}
else{var opposite=$('#'+$(this).attr('id').replace(/_B$/,"_A")).find('.filled_pair:first');}
if(opposite.length>0){var oppositeId=opposite.attr('id').replace('pair_','');if(_matchGroup.length>0){if($.inArray(oppositeId,_matchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}
var _oppositeMatchGroup=ctx.options["matchMaxes"][oppositeId]["matchGroup"];if(_oppositeMatchGroup.length>0){if($.inArray(draggedId,_oppositeMatchGroup)<0){$(this).effect("highlight",{color:'#B02222'},1000);return false;}}}
if($(this).html()!=''){$('.filled_pair',$(this)).each(function(){ctx.removeFilledPair($(this));});}
$(ui.helper).css({top:"0",left:"0"});ctx.fillPair($(this),$(ui.draggable));},hoverClass:'active'});},setResponse:function(values){var ctx=this;var index=1;if(typeof(values)==='object'){for(var i in values){var pair=values[i];if(pair.length===2){var valA=pair[0];if(typeof(valA)==='string'&&valA!=''){if($('#'+ctx.id+" li#"+valA).length===1){this.fillPair($('#'+ctx.id+"_"+index+"_A"),$('#'+ctx.id+" .qti_associate_interaction_container .qti_choice_list li#"+valA+" > div"));}}
var valB=pair[1];if(typeof(valB)==='string'&&valB!=''){if($('#'+ctx.id+" li#"+valB).length===1){this.fillPair($('#'+ctx.id+"_"+index+"_B"),$('#'+ctx.id+" .qti_associate_interaction_container .qti_choice_list li#"+valB+" > div"));}}
index++;}}}},getResponse:function(){return this.resultCollector.associate();},fillPair:function(jDropped,jDragged){var ctx=this;if(jDropped.length&&jDragged.length){jDropped.addClass('ui-state-highlight');var draggedId=jDragged.parents().attr('id');jDropped.html("<div id='pair_"+draggedId+"' class='filled_pair'>"+jDragged.html()+"</div>");$('#'+ctx.id+" #pair_"+draggedId).width($('#'+ctx.id+" .qti_association_pair li").width());$('#'+ctx.id+" #pair_"+draggedId).height($('#'+ctx.id+" .qti_association_pair li").height());var _matchMax=Number(ctx.options["matchMaxes"][draggedId]["matchMax"]);var _current=Number(ctx.options["matchMaxes"][draggedId]["current"]);if(_current<_matchMax){_current++;ctx.options["matchMaxes"][draggedId]["current"]=_current;}
if(_current>=_matchMax&&_matchMax>0){jDragged.hide();}
$('#'+ctx.id+" #pair_"+draggedId).draggable({drag:function(event,ui){$(this).css("z-index","999");},stop:function(event,ui){ctx.removeFilledPair($(this));return true;},containment:'#'+ctx.id,cursor:"move"});}},removeFilledPair:function(jElement){var ctx=this;var filledId=jElement.attr("id").replace('pair_','');var _matchMax=Number(ctx.options["matchMaxes"][filledId]["matchMax"]);var _current=Number(ctx.options["matchMaxes"][filledId]["current"]);if(_current>0){ctx.options["matchMaxes"][filledId]["current"]=_current-1;}
jElement.parents('li').removeClass('ui-state-highlight');jElement.remove();if(_current>=_matchMax){$("#"+filledId+" div").show();}}});
QtiWidget.DefaultWidget.ChoiceInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){var maxChoices=parseInt(this.options["maxChoices"]);if(maxChoices>1||maxChoices===0){this.renderMultiChoice();}else{this.renderSingleChoice();}},setResponse:function(values){var maxChoices=parseInt(this.options["maxChoices"]);if(maxChoices>1||maxChoices===0){this.setMultiChoiceResponse(values);}else{this.setSingleChoiceResponse(values);}},getResponse:function(){return this.resultCollector.choice();},renderSingleChoice:function(){var ctx=this;$('#'+this.id).addClass('qti_simple_interaction');$('#'+this.id+" ul li").bind("click",function(){$('#'+ctx.id+" ul li").removeClass("tabActive");$(this).addClass("tabActive");});},renderMultiChoice:function(){var ctx=this;$('#'+ctx.id).addClass('qti_multi_interaction');$('#'+ctx.id+" ul li").bind("click",function(){if($(this).hasClass("tabActive")){$(this).removeClass("tabActive");}else{if($('#'+ctx.id+" ul li.tabActive").length<ctx.options["maxChoices"]||ctx.options["maxChoices"]==0){$(this).addClass("tabActive");}}});},setSingleChoiceResponse:function(value){if(value){if(typeof(value)==='string'&&value!==''){$('#'+this.id+" ul li#"+value).addClass("tabActive");}}},setMultiChoiceResponse:function(values){if(values){if(typeof(values)==='object'){for(var i in values){var value=values[i];if(typeof(value)==='string'&&value!==''){$('#'+this.id+" ul li#"+value).addClass("tabActive");}}}}}});
QtiWidget.DefaultWidget.EndAttemptInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){},setResponse:function(values){},getResponse:function(){}});
QtiWidget.DefaultWidget.ExtendedTextInteraction=QtiWidget.DefaultWidget.StringInteraction.extend({init:function(interaction){this._super(interaction);this.options.multiple=false;var tagname=$('#'+this.id).prop('tagName').toLowerCase();if(tagname==='div'){this.options.multiple=true;}},render:function(){if(!this.options.multiple){if(this.options['expectedLength']||this.options['expectedLines']){var baseWidth=parseInt($('#'+this.id).css('width'))|640;var baseHeight=parseInt($('#'+this.id).css('height'))|100;if(this.options['expectedLength']){var expectedLength=parseInt(this.options['expectedLength']);if(expectedLength>0){var width=expectedLength*10;if(width>baseWidth){var height=(width/baseWidth);if(height>baseHeight){$('#'+this.id).css('height',height+'em');}}}}
if(this.options['expectedLines']){$('#'+this.id).css('height',parseInt(this.options['expectedLines'])+'em');}}
this._super();}else{if(this.options['expectedLength']){var expectedLength=parseInt(this.options['expectedLength']);if(expectedLength>0){$('#'+this.id+' :text').css('width',expectedLength+'em');}}
if(this.options['patternMask']){var pattern=new RegExp("/^"+this.options['patternMask']+"$/");$('#'+this.id+' :text').change(function(){$(this).removeClass('field-error');if(!pattern.test($(this).val())){$(this).addClass('field-error');}});}}},setResponse:function(values){if(!this.options.multiple){this._super(values);}else{if(typeof(values)==='object'){for(var i in values){var value=values[i];if(typeof(value)==='string'&&value!=''){$('#'+this.id+" :text"+'#'+this.id+"_"+i).val(value);}}}}}});
QtiWidget.DefaultWidget.GapMatchInteraction=QtiWidget.DefaultWidget.Widget.extend({maxBoxSize:0,init:function(interaction){this._super(interaction);this.options.matchMaxes={};for(var i in interaction.choices){var choice=interaction.choices[i];this.options.matchMaxes[choice.attr('identifier')]={'matchMax':parseInt(choice.attr('matchMax')),'matchGroup':[],'current':0}}
this.maxBoxSize=0;},render:function(){var ctx=this;$('#'+ctx.id+" .qti_choice_list").wrap("<div class='qti_gap_match_container'></div>");$('#'+ctx.id+" .qti_choice_list li").wrapInner("<div></div>");$('#'+ctx.id+" .qti_choice_list li:last").after("<li><div></div></li>");$('#'+ctx.id+" .qti_choice_list li:last").css('clear','both');$('#'+ctx.id+" ul.qti_choice_list li > div").each(function(){if($(this).width()>ctx.maxBoxSize){ctx.maxBoxSize=$(this).width();}});ctx.maxBoxSize=((parseInt(ctx.maxBoxSize)/2)+5)+'px';$('#'+ctx.id+" .gap").css({"padding-left":ctx.maxBoxSize,"padding-right":ctx.maxBoxSize});$('#'+ctx.id+" .qti_gap_match_container .qti_choice_list li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},containment:'#'+ctx.id,revert:true,cursor:"move"});$('#'+ctx.id+" .gap").html('&nbsp;');$('#'+ctx.id+" .gap").droppable({drop:function(event,ui){var draggedId=$(ui.draggable).parent().attr("id");if($(this).find("#gap_"+draggedId).length>0||/^gap_/.test($(ui.draggable).attr('id'))){return false;}
if($(this).html()!=''){$('.filled_gap',$(this)).each(function(){ctx.removeFilledGap($(this));});}
ctx.fillGap($(this),$(ui.draggable));},hoverClass:'active'});},setResponse:function(values){if(typeof(values)==='object'){for(var i in values){var value=values[i];if(value['0']&&value['1']){var gap=value['0'];var choice=value['1'];this.fillGap($('#'+this.id+" .gap#"+gap),$('#'+this.id+" .qti_choice_list li#"+choice+" > div"));}}}},getResponse:function(){return this.resultCollector.gap_match();},fillGap:function(jDropped,jDragged){var ctx=this;var draggedId=jDragged.parent().attr("id");var _matchMax=Number(ctx.options["matchMaxes"][draggedId]["matchMax"]);var _current=Number(ctx.options["matchMaxes"][draggedId]["current"]);jDropped.addClass('dropped_gap');if(_current<_matchMax){_current++;ctx.options["matchMaxes"][draggedId]["current"]=_current;}
if(_matchMax&&_current>=_matchMax){jDragged.hide();}
setTimeout(function(){jDropped.css({'padding-left':'5px','padding-right':'5px'});jDropped.html("<span id='gap_"+draggedId+"' class='filled_gap'>"+jDragged.text()+"</span>");$('#'+ctx.id+" .filled_gap").draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");$(this).parent().addClass('ui-state-highlight');},stop:function(){$(this).parent().removeClass('ui-state-highlight');ctx.removeFilledGap($(this));},revert:false,containment:'#'+ctx.id,cursor:"move"});},500);},removeFilledGap:function(jElement){var filledId=jElement.attr("id").replace('gap_','');var _matchMax=Number(this.options["matchMaxes"][filledId]["matchMax"]);var _current=Number(this.options["matchMaxes"][filledId]["current"]);if(_current>0){this.options["matchMaxes"][filledId]["current"]=_current-1;}
jElement.parent().css({"padding-left":this.maxBoxSize,"padding-right":this.maxBoxSize}).removeClass('dropped_gap').html('&nbsp;');jElement.remove();if(_current>=_matchMax){$("#"+filledId+" div").show();}}});
QtiWidget.DefaultWidget.GraphicAssociateInteraction=QtiWidget.DefaultWidget.GraphicInteraction.extend({render:function(){var ctx=this;ctx.countChoices=ctx.options.maxAssociations;ctx.pointsPair=[];var imageHeight=parseInt(ctx.options.imageHeight);var imageWidth=parseInt(ctx.options.imageWidth);$('#'+ctx.id).append('<div class="link_counter">0</div>').append('<div class="sub_counter"></div>');if(isNaN(imageHeight)||isNaN(imageWidth)){$('#'+ctx.id).append("<div class='img-loader' style='visibility:hidden;'></div>");var $loadedImg=$("<img src='"+ctx.options.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$('#'+ctx.id+' .img-loader').remove();ctx.createArea(imageWidth,imageHeight);});$('#'+ctx.id+' .img-loader').append($loadedImg);}else{ctx.createArea(imageWidth,imageHeight);}},setResponse:function(values){if(typeof(values)==='object'){if(typeof(values[0])==='string'&&typeof(values[1])==='string'){this.associate(values[0],values[1]);}
for(var index in values){var value=values[index];if(typeof(value)==='object'){if(typeof(value[0])==='string'&&typeof(value[1])==='string'){this.associate(value[0],value[1]);}}}}},getResponse:function(){return this.resultCollector.graphic_associate();},createArea:function(imageWidth,imageHeight){var ctx=this;$('#'+ctx.id).prepend("<div class='svg-container'></div>");ctx.$raphaelCanvas=$('#'+ctx.id+' .svg-container');var paper=Raphael(ctx.$raphaelCanvas[0],imageWidth,imageHeight);paper.image(ctx.options.imagePath,0,0,imageWidth,imageHeight);ctx.paper=paper;ctx.shapes={};ctx.line_ref_obj={};if(ctx.options.maxAssociations>0){$('#'+ctx.id+" .link_counter").text(ctx.options.maxAssociations);}else{$('#'+ctx.id+" .link_counter").html("<span class='infiniteSize'>âˆž</span>");}
ctx.$deleteButton=$('<span id="qti-graphic-associate-delete-link"></span>').appendTo('#'+ctx.id);ctx.$deleteButton.hide();for(var choiceId in ctx.options.graphicChoices){var currentHotSpotShape=ctx.options.graphicChoices[choiceId].shape;var currentHotSpotCoords=ctx.options.graphicChoices[choiceId].coords.split(",");var currentHotSpotX,currentHotSpotY,currentHotSpotSize,currentHotSpotTopX,currentHotSpotTopY;var currentHotSpotBottomX,currentHotSpotBottomY,currentHotSpotHradius,currentHotSpotVradius;var pointerSize=6,pointer,polyCoords,currentShape,shapeWidth,shapeHeight;switch(currentHotSpotShape){case"circle":currentHotSpotX=Number(currentHotSpotCoords[0]);currentHotSpotY=Number(currentHotSpotCoords[1]);currentHotSpotSize=currentHotSpotCoords[2];currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotSize);if(ctx.graphicDebug)
currentShape.attr("stroke-width","3px");pointer=paper.circle(currentHotSpotX,currentHotSpotY,pointerSize);break;case"rect":currentHotSpotTopX=Number(currentHotSpotCoords[0]);currentHotSpotTopY=Number(currentHotSpotCoords[1]);currentHotSpotBottomX=currentHotSpotCoords[2]-currentHotSpotTopX;currentHotSpotBottomY=currentHotSpotCoords[3]-currentHotSpotTopY;currentShape=paper[currentHotSpotShape](currentHotSpotTopX,currentHotSpotTopY,currentHotSpotBottomX,currentHotSpotBottomY);if(ctx.graphicDebug)
currentShape.attr("stroke-width","3px");shapeWidth=currentShape.getBBox().width;shapeHeight=currentShape.getBBox().height;pointer=paper.circle(currentHotSpotTopX+(shapeWidth/2),currentHotSpotTopY+(shapeHeight/2),pointerSize);break;case"ellipse":currentHotSpotX=Number(currentHotSpotCoords[0]);currentHotSpotY=Number(currentHotSpotCoords[1]);currentHotSpotHradius=currentHotSpotCoords[2];currentHotSpotVradius=currentHotSpotCoords[3];currentShape=paper[currentHotSpotShape](currentHotSpotX,currentHotSpotY,currentHotSpotHradius,currentHotSpotVradius);if(ctx.graphicDebug)
currentShape.attr("stroke-width","3px");pointer=paper.circle(currentHotSpotX,currentHotSpotY,pointerSize);break;case"poly":polyCoords=QtiWidget.DefaultWidget.polyCoordonates(ctx.options.graphicChoices[choiceId]["coords"]);currentShape=paper.path(polyCoords);if(ctx.graphicDebug)
currentShape.attr("stroke-width","3px");var polyCenter=QtiWidget.DefaultWidget.getShapeCenter(currentShape);pointer=paper.circle(polyCenter.x,polyCenter.y,pointerSize);break;}
if(!currentShape){return;}
var maxSubLink=ctx.options.graphicChoices[choiceId].matchMax||0;ctx.shapes[choiceId]={pointer:pointer,shape:currentShape,pointerState:"hidden",linkRelation:{},maxSubLinkLength:maxSubLink};pointer.attr("fill","black");pointer.attr("opacity","0");currentShape.toFront();QtiWidget.DefaultWidget.setDeactivatedShapeAttr(currentShape);ctx.options[currentShape.node]=choiceId;$(currentShape.node).bind("mousedown",{'choiceId':choiceId},function(e){ctx.select(e.data.choiceId);});}},select:function(choiceId){var ctx=this;for(var i in ctx.line_ref_obj){ctx.line_ref_obj[i].attr("stroke","black").attr('stroke-width','4');}
ctx.$deleteButton.off('mousedown');var pointer=ctx.shapes[choiceId].pointer;ctx.$deleteButton.hide();pointer.attr("fill","red");pointer.attr("stroke","white");if(ctx.pointsPair.length<1){ctx.pointsPair.push(choiceId);var maxSubLinkLength=ctx.shapes[choiceId].maxSubLinkLength;if(maxSubLinkLength<1||isNaN(maxSubLinkLength)){$('#'+ctx.id+" .sub_counter").html("<span class='infiniteSize'>&#8734;</span>");}else{var currentLinkLength=ctx.displayedSubLink(ctx.shapes[choiceId].linkRelation);var maxLinkAvalaible=maxSubLinkLength-currentLinkLength;$('#'+ctx.id+" .sub_counter").text(maxLinkAvalaible);}}else{ctx.pointsPair.push(choiceId);var startId=ctx.pointsPair[0];var endId=ctx.pointsPair[1];var startPointer=ctx.shapes[ctx.pointsPair[0]].pointer;var endPointer=ctx.shapes[ctx.pointsPair[1]].pointer;var relation=ctx.pointsPair[0]+' '+ctx.pointsPair[1];var targetRelation=ctx.pointsPair[1]+' '+ctx.pointsPair[0];if(startPointer==endPointer){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");ctx.hideSinglePoint(ctx.shapes,ctx.pointsPair[0],ctx.pointsPair[1],startPointer,endPointer);ctx.emptyArray(ctx.pointsPair);$('#'+ctx.id+" .sub_counter").text("");startPointer.attr("opacity","0");return;}
if(ctx.countChoices==0&&ctx.options.maxAssociations!=0){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");ctx.hideSinglePoint(ctx.shapes,ctx.pointsPair[0],ctx.pointsPair[1],startPointer,endPointer);ctx.emptyArray(ctx.pointsPair);return;}
var subLinkLength=ctx.displayedSubLink(ctx.shapes[ctx.pointsPair[0]].linkRelation);var targetSubLinkLength=ctx.displayedSubLink(ctx.shapes[ctx.pointsPair[1]].linkRelation);if(ctx.shapes[ctx.pointsPair[0]].maxSubLinkLength==0){if((targetSubLinkLength+1)>ctx.shapes[ctx.pointsPair[1]].maxSubLinkLength&&ctx.shapes[ctx.pointsPair[1]].maxSubLinkLength!=0){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");ctx.hideSinglePoint(ctx.shapes,ctx.pointsPair[0],ctx.pointsPair[1],startPointer,endPointer);ctx.emptyArray(ctx.pointsPair);return;}}else
if(subLinkLength>=ctx.shapes[ctx.pointsPair[0]].maxSubLinkLength||(targetSubLinkLength+1)>ctx.shapes[ctx.pointsPair[1]].maxSubLinkLength){if(ctx.shapes[ctx.pointsPair[1]].maxSubLinkLength!=0){startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");ctx.hideSinglePoint(ctx.shapes,ctx.pointsPair[0],ctx.pointsPair[1],startPointer,endPointer);ctx.emptyArray(ctx.pointsPair);return;}}
if(ctx.shapes[ctx.pointsPair[0]].linkRelation[relation]!=undefined){ctx.emptyArray(ctx.pointsPair);return;}
var startPointX=startPointer.getBBox().x+startPointer.getBBox().width/2;var startPointY=startPointer.getBBox().y+startPointer.getBBox().width/2;var endPointX=endPointer.getBBox().x+endPointer.getBBox().width/2;var endPointY=endPointer.getBBox().y+endPointer.getBBox().width/2;var drawingPath="M"+startPointX+" "+startPointY+"L"+endPointX+" "+endPointY;var line=ctx.paper.path(drawingPath);line.attr('stroke-width','3');line.toFront();startPointer.attr("fill","black");startPointer.attr("stroke","black");endPointer.attr("fill","black");endPointer.attr("stroke","black");ctx.shapes[startId].linkRelation[relation]={};ctx.shapes[startId].linkRelation[relation].lineRef=line;ctx.shapes[startId].linkRelation[relation].endRef=endPointer;ctx.shapes[endId].linkRelation[targetRelation]={};ctx.shapes[endId].linkRelation[targetRelation].lineRef=line;ctx.shapes[endId].linkRelation[targetRelation].endRef=startPointer;ctx.line_ref_obj[relation]=line;var pairs=[];for(var aPair in ctx.line_ref_obj){pairs.push(aPair);}
$('#'+ctx.id).data('pairs',pairs);ctx.emptyArray(ctx.pointsPair);var pairOfPoints=ctx.pointsPair;$(line.node).on("mousedown",{zeline:line,centerX:(startPointX+endPointX)/2,centerY:(startPointY+endPointY)/2,zerelation:relation},function(e){var localRelation=e.data.zerelation;var localLine=e.data.zeline;for(var i in ctx.line_ref_obj){ctx.line_ref_obj[i].attr("stroke","black");}
ctx.$deleteButton.show();ctx.$deleteButton.css("left",ctx.$raphaelCanvas.offset().left+e.data.centerX-7);ctx.$deleteButton.css("top",ctx.$raphaelCanvas.offset().top+e.data.centerY-7);ctx.$deleteButton.off("mousedown").on("mousedown",function(e){e.preventDefault();delete ctx.shapes[startId].linkRelation[localRelation];delete ctx.shapes[endId].linkRelation[targetRelation];localLine.remove();$(this).hide();if(ctx.options.maxAssociations>0&&ctx.countChoices<ctx.options.maxAssociations){ctx.countChoices++;$('#'+ctx.id+" .link_counter").text(ctx.countChoices);}
ctx.hideSinglePoint(ctx.shapes,startId,endId,startPointer,endPointer);delete ctx.line_ref_obj[localRelation];ctx.emptyArray(pairOfPoints);var pairs=[];for(var aPair in ctx.line_ref_obj){pairs.push(aPair);}
$('#'+ctx.id).data('pairs',pairs);$(this).unbind("mousedown");});var line=e.data.zeline;line.attr("stroke","red");});if(ctx.options.maxAssociations>0){ctx.countChoices--;$('#'+ctx.id+" .link_counter").text(ctx.countChoices);}
ctx.shapes[choiceId].shape.toFront();}
ctx.shapes[choiceId].pointer.attr("opacity","1");ctx.shapes[choiceId].pointerState="show";for(var t in ctx.shapes){ctx.shapes[t].shape.toFront();}},associate:function(hotspot1,hotspot2){this.select(hotspot1);this.select(hotspot2);},hideSinglePoint:function(obj,startId,endId,startPointer,endPointer){var rela=0;for(var z in obj[startId].linkRelation){rela++;}
var relb=0;for(var e in obj[endId].linkRelation){relb++;}
if(rela<1){startPointer.attr("opacity","0");}
if(relb<1){endPointer.attr("opacity","0");}},emptyArray:function(arr){while(arr.length>0){arr.pop();}},displayedSubLink:function(obj){var i=0;for(var a in obj){i++;}
return i;}});
QtiWidget.DefaultWidget.GraphicGapMatchInteraction=QtiWidget.DefaultWidget.GraphicInteraction.extend({init:function(interaction,context){this._super(interaction,context);var choices=interaction.getChoices();for(var i in choices){this.options.graphicChoices[choices[i].id()].matchMax=choices[i].attr('matchMax')||0;}
var gapImgs=interaction.getGapImgs();for(var i in gapImgs){this.options.graphicChoices[gapImgs[i].id()]={'matchMax':gapImgs[i].attr('matchMax')||0,'current':0};}},render:function(){var ctx=this;ctx.shapes=[];$('#'+ctx.id+' ul.choice_list').hide();$('#'+ctx.id+' .qti_graphic_gap_match_spotlist li').wrapInner('<div></div>');$('#'+ctx.id+" .qti_graphic_gap_match_spotlist li:last").after("<li></li>");$('#'+ctx.id+" .qti_graphic_gap_match_spotlist li:last").css('clear','both');var containerHeight=0;$('#'+ctx.id+' .qti_graphic_gap_match_spotlist li').each(function(){var height=parseInt($(this).height());if(height>containerHeight){containerHeight=height;}});var containerWidth=5;$('#'+ctx.id+' .qti_graphic_gap_match_spotlist li').each(function(){containerWidth+=parseInt($(this).width())+4;});$('#'+ctx.id+' .qti_graphic_gap_match_spotlist').width(containerWidth).height(containerHeight);$('#'+ctx.id+" .qti_graphic_gap_match_spotlist li > div").draggable({drag:function(event,ui){$(ui.helper).css("z-index","888");},containment:'#'+ctx.id,revert:true,cursor:'move'});var imageHeight=parseInt(ctx.options.imageHeight);var imageWidth=parseInt(ctx.options.imageWidth);var itemHeight=parseInt($('#'+ctx.id).height());$('#'+ctx.id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$('#'+ctx.id).append("<div class='img-loader' style='visibility:hidden;'></div>");var $loadedImg=$("<img src='"+ctx.options.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$('#'+ctx.id+' .img-loader').remove();ctx.createArea(imageWidth,imageHeight);});$('#'+ctx.id+' .img-loader').append($loadedImg);}else{ctx.createArea(imageWidth,imageHeight);}},setResponse:function(values){if(typeof(values)==='object'){for(var i in values){var value=values[i];if(value['0']&&value['1']){var hotspot=value['0'];var gapImg=value['1'];this.fillGap(hotspot,gapImg);}}}},getResponse:function(){return this.resultCollector.graphic_gap_match();},createArea:function(imageWidth,imageHeight){var ctx=this;$('#'+ctx.id+' .qti_graphic_gap_match_spotlist').before("<div class='svg-container'></div>");var paper=Raphael($('#'+ctx.id+' .svg-container')[0],imageWidth,imageHeight);paper.image(ctx.options.imagePath,0,0,imageWidth,imageHeight);ctx.paper=paper;var collisables=[];for(var choiceId in ctx.options.graphicChoices){var currentHotSpotShape=ctx.options.graphicChoices[choiceId].shape;var currentHotSpotCoords=ctx.options.graphicChoices[choiceId].coords;if(currentHotSpotShape&&currentHotSpotCoords){var currentShape=this.buildShape(currentHotSpotShape,currentHotSpotCoords.split(','));currentShape.toFront();currentShape.id=choiceId;QtiWidget.DefaultWidget.setDeactivatedShapeAttr(currentShape);ctx.shapes[choiceId]=currentShape;collisables.push(currentShape);}}
var offset=$('#'+ctx.id+' .svg-container').offset();var collisionContext={raphShape:paper,collisables:collisables,offsetLeft:offset.left,offsetTop:offset.top};$('#'+ctx.id+' .svg-container').droppable({accept:'#'+ctx.id+" .qti_graphic_gap_match_spotlist li > div",drop:function(event,ui){var result=ctx.detectMouseCollision(event,collisionContext);if(result.length>0){var gapImgId=$(ui.draggable).parent().attr("id");return ctx.fillGap(result[0][2].id,gapImgId);}}});},detectMouseCollision:function(event,params){return raphaelcollision(params.raphShape,params.collisables,event.pageX-((params.offsetLeft)?params.offsetLeft:0),event.pageY-((params.offsetTop)?params.offsetTop:0));},getFilledId:function(hotspotId,gapImgId){return'gap_'+hotspotId+'_'+gapImgId;},fillGap:function(hotspotId,gapImgId){var ctx=this;var raphShape=ctx.shapes[hotspotId];var $jDropped=$('#'+ctx.id+' .svg-container');var $jDragged=$('#'+gapImgId+' div.ui-draggable');var filledId=ctx.getFilledId(hotspotId,gapImgId);if(!raphShape){throw'No shape found for the hotspot: '+hotspotId;}
if($('#'+ctx.id+' #'+filledId).length>0){return false;}
var _hotspotMatchMax=parseInt(ctx.options.graphicChoices[hotspotId].matchMax);var _hotspotCurrent=parseInt(ctx.options.graphicChoices[hotspotId].current);_hotspotCurrent=isNaN(_hotspotCurrent)?0:_hotspotCurrent;if(_hotspotMatchMax==0||_hotspotCurrent<_hotspotMatchMax){ctx.options.graphicChoices[hotspotId].current=parseInt(_hotspotCurrent+1);}else{QtiWidget.DefaultWidget.animateForbiddenShape(raphShape);return false}
QtiWidget.DefaultWidget.animateAllowedShape(raphShape);var responseId=ctx.resultCollector.append({'hotspot':hotspotId,'gapImg':gapImgId});var _gapImgMatchMax=parseInt(ctx.options.graphicChoices[gapImgId].matchMax);var _gapImgCurrent=parseInt(ctx.options.graphicChoices[gapImgId].current);_gapImgCurrent=isNaN(_gapImgCurrent)?0:_gapImgCurrent;if(_gapImgMatchMax==0||_gapImgCurrent<_gapImgMatchMax){_gapImgCurrent++;ctx.options["graphicChoices"][gapImgId].current=_gapImgCurrent;if(_gapImgMatchMax>0&&_gapImgCurrent>=_gapImgMatchMax){$jDragged.hide();}}
$jDropped.append("<div id='"+filledId+"' class='filled_gap'>"+$jDragged.html()+"</span>");var $image=$jDragged.find('img');var gapCenter=QtiWidget.DefaultWidget.getShapeCenter(raphShape);$('#'+ctx.id+' #'+filledId).css({'top':gapCenter.y-$image.attr('height')/2,'left':gapCenter.x-$image.attr('width')/2});$('#'+ctx.id+' #'+filledId).draggable({drag:function(event,ui){$(ui.helper).css("z-index","999");},stop:function(){ctx.resultCollector.remove(responseId);ctx.removeFilledGap(hotspotId,gapImgId);},revert:false,containment:'#'+ctx.id,cursor:"move"});},removeFilledGap:function(hotspotId,gapImgId){var ctx=this;if(gapImgId.length){var _matchMax=Number(ctx.options.graphicChoices[gapImgId].matchMax);var _current=Number(ctx.options.graphicChoices[gapImgId].current);if(_current>0)
_current--;ctx.options.graphicChoices[gapImgId].current=_current;if(_current<_matchMax){$('#'+ctx.id+' #'+gapImgId+" div").show();}}
$('#'+ctx.getFilledId(hotspotId,gapImgId)).remove();if(hotspotId.length){var _matchMax=Number(ctx.options.graphicChoices[hotspotId].matchMax);var _current=Number(ctx.options.graphicChoices[hotspotId].current);if(_current>0)
_current--;ctx.options.graphicChoices[hotspotId].current=_current;}}});
QtiWidget.DefaultWidget.GraphicOrderInteraction=QtiWidget.DefaultWidget.GraphicInteraction.extend({countChoices:0,shapes:[],orderedElements:[],paper:null,pickedNumber:0,init:function(interaction,context){this._super(interaction,context);if(!this.options.maxChoices){var choicesCount=0;for(var i in this.options.graphicChoices){if(this.options.graphicChoices.hasOwnProperty(i)){choicesCount++;}}
this.options.maxChoices=choicesCount;}},render:function(){var ctx=this;this.countChoices=0;this.shapes={};var imageHeight=parseInt(ctx.options.imageHeight);var imageWidth=parseInt(ctx.options.imageWidth);$('#'+ctx.id+" .qti_graphic_order_spotlist li").css("display","none");var itemHeight=parseInt($('#'+ctx.id).height());$('#'+ctx.id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$('#'+ctx.id).append("<div class='img-loader' style='visibility:hidden;'></div>");var $loadedImg=$("<img src='"+ctx.options.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$('#'+ctx.id+' .img-loader').remove();ctx.createArea(imageWidth,imageHeight,itemHeight);});$('#'+ctx.id+' .img-loader').append($loadedImg);}else{ctx.createArea(imageWidth,imageHeight,itemHeight);}},setResponse:function(values){if(typeof(values)==='object'){var list=new Array(values.length);for(var index in values){var value=values[index];if(typeof(value)==='string'&&value!=''){this.setOrder(parseInt(index)+1,value);}}}},getResponse:function(){return this.resultCollector.graphic_order();},createArea:function(imageWidth,imageHeight,itemHeight){this.orderedElements={};var ctx=this;$('#'+ctx.id).append("<div class='svg-container'></div>");var paper=Raphael($('#'+ctx.id+' .svg-container')[0],imageWidth,imageHeight);paper.image(ctx.options.imagePath,0,0,imageWidth,imageHeight);this.paper=paper;$('#'+ctx.id).append("<ul class='pickup_area'></ul>");for(var a=1;a<=ctx.options.maxChoices;a++){$('#'+ctx.id+" .pickup_area").append('<li id="picked_num_'+a+'">'+a+"</li>");}
$('#'+ctx.id+" .pickup_area li").each(function(e){$(this).bind("click",function(e){var nbr=parseInt($(this).attr('id').replace('picked_num_',''));ctx.pickNumber(nbr);});});$('#'+ctx.id+" .pickup_area").width(imageWidth-10-4);var pickup_area_height=parseInt($('#'+ctx.id+" .pickup_area").height());$('#'+ctx.id).css("height",itemHeight+imageHeight+pickup_area_height+20);$('#'+ctx.id).height(parseInt($('#'+ctx.id).height())+pickup_area_height);for(var choiceId in ctx.options.graphicChoices){var currentHotSpotShape=ctx.options.graphicChoices[choiceId]["shape"];var currentHotSpotCoords=ctx.options.graphicChoices[choiceId]["coords"].split(",");var currentShape=this.buildShape(currentHotSpotShape,currentHotSpotCoords);if(currentShape){ctx.shapes[choiceId]=currentShape;currentShape.toFront();QtiWidget.DefaultWidget.setDeactivatedShapeAttr(currentShape);ctx.orderedElements[choiceId]={state:"empty",order:0,numberIn:null,numberOut:null,choiceItemRef:null};$(currentShape.node).bind("mousedown",{'choiceId':choiceId},function(e){ctx.setOrder(ctx.pickedNumber,e.data.choiceId);});}}},pickNumber:function(nbr){$('#'+this.id+' .pickup_area li').removeClass("selected");$('#'+this.id+' .pickup_area li#picked_num_'+nbr).addClass("selected");this.pickedNumber=nbr;},releaseNumber:function(nbr){$('#'+this.id+" .pickup_area li#picked_num_"+nbr).css("visibility","hidden").removeClass("selected");this.pickedNumber=0;},setOrder:function(number,choiceId){var ctx=this;if(!ctx.orderedElements[choiceId]){throw'undefined choiceid in graphic order: '+choiceId;}
if(ctx.orderedElements[choiceId].state==="empty"&&number===0){return;}
if(ctx.orderedElements[choiceId].state==="empty"&&number>0){var currentShape=this.shapes[choiceId];ctx.orderedElements[choiceId].state="filled";ctx.orderedElements[choiceId].order=number;QtiWidget.DefaultWidget.setActivatedShapeAttr();var coords=QtiWidget.DefaultWidget.getShapeCenter(currentShape);var orderInfo=ctx.paper.text(coords.x,coords.y,number);var orderInfo1=ctx.paper.text(coords.x,coords.y,number);ctx.orderedElements[choiceId].numberIn=orderInfo;ctx.orderedElements[choiceId].numberOut=orderInfo1;var $choiceItemRef=$('#'+ctx.id+" .pickup_area li#picked_num_"+number);ctx.orderedElements[choiceId].choiceItemRef=$choiceItemRef;orderInfo.attr("font-family","verdana");orderInfo.attr("font-size",16);orderInfo.attr("font-weight","bold");orderInfo.attr("fill","#009933");orderInfo.attr("stroke","#009933");orderInfo.attr("stroke-width","3px");orderInfo1.attr("font-family","verdana");orderInfo1.attr("font-size",16);orderInfo1.attr("font-weight","bold");orderInfo1.attr("fill","#ffffff");currentShape.toFront();ctx.releaseNumber(number);}else{QtiWidget.DefaultWidget.setDeactivatedShapeAttr(currentShape,400);ctx.orderedElements[choiceId].numberIn.remove();ctx.orderedElements[choiceId].numberOut.remove();ctx.orderedElements[choiceId].state="empty";ctx.orderedElements[choiceId].choiceItemRef.css("visibility","visible");}
var response={};for(var id in ctx.orderedElements){var orderedElt=ctx.orderedElements[id];if(orderedElt.state!=='empty'){response[parseInt(orderedElt.order)-1]=id;}}
ctx.resultCollector.set(response);}});
QtiWidget.DefaultWidget.HotspotInteraction=QtiWidget.DefaultWidget.GraphicInteraction.extend({countChoices:0,shapes:[],paper:null,render:function(){var ctx=this;ctx.countChoices=0;ctx.shapes=[];var imageHeight=parseInt(ctx.options.imageHeight);var imageWidth=parseInt(ctx.options.imageWidth);var itemHeight=parseInt($('#'+ctx.id).height());$('#'+ctx.id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$('#'+ctx.id).append("<div class='img-loader' style='visibility:hidden;'></div>");var $loadedImg=$("<img src='"+ctx.options.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$('#'+ctx.id+' .img-loader').remove();ctx.createArea(imageWidth,imageHeight,itemHeight);});$('#'+ctx.id+' .img-loader').append($loadedImg);}
else{ctx.createArea(imageWidth,imageHeight,itemHeight);}},setResponse:function(values){if(typeof(values)==='object'){for(var i in values){this.select(values[i]);}}
if(typeof(values)==='string'){this.select(values);}},getResponse:function(){return this.resultCollector.hotspot();},createArea:function(imageWidth,imageHeight,itemHeight){var ctx=this;$('#'+ctx.id).append("<div class='svg-container'></div>");var paper=Raphael($('#'+ctx.id+' .svg-container')[0],imageWidth,itemHeight+imageHeight);paper.image(ctx.options.imagePath,0,0,imageWidth,imageHeight);this.paper=paper;for(var choiceId in ctx.options.graphicChoices){var currentHotSpotShape=ctx.options.graphicChoices[choiceId]["shape"];var currentHotSpotCoords=ctx.options.graphicChoices[choiceId]["coords"].split(",");var currentShape=this.buildShape(currentHotSpotShape,currentHotSpotCoords);if(currentShape){currentShape.toFront();QtiWidget.DefaultWidget.setDeactivatedShapeAttr(currentShape);ctx.shapes[choiceId]=currentShape;$(currentShape.node).bind("mousedown",{'choiceId':choiceId},function(e){ctx.select(e.data.choiceId);});}}},select:function(choiceId){var responseIndex=this.resultCollector.isSet(choiceId)
if(responseIndex>=0){this.countChoices-=1;QtiWidget.DefaultWidget.setDeactivatedShapeAttr(this.shapes[choiceId]);this.resultCollector.remove(responseIndex);}else{if(this.countChoices>=this.options.maxChoices){return;}
this.countChoices+=1;QtiWidget.DefaultWidget.setActivatedShapeAttr(this.shapes[choiceId]);this.paper.safari();this.resultCollector.append(choiceId);}}});
QtiWidget.DefaultWidget.HottextInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){var ctx=this;var maxChoices=(ctx.options['maxChoices'])?parseInt(ctx.options['maxChoices']):1;$('#'+ctx.id+" .hottext_choice").click(function(){if(maxChoices===0){$(this).toggleClass('hottext_choice_on').toggleClass('hottext_choice_off');}
if(maxChoices===1){if($('#'+ctx.id+" .hottext_choice").length===1){$(this).toggleClass('hottext_choice_on').toggleClass('hottext_choice_off');}else{$('#'+ctx.id+" .hottext_choice").removeClass('hottext_choice_on').addClass('hottext_choice_off');$(this).removeClass('hottext_choice_off').addClass('hottext_choice_on');}}
if(maxChoices>1){if($('#'+ctx.id+" .hottext_choice_on").length<maxChoices||$(this).hasClass('hottext_choice_on')){$(this).toggleClass('hottext_choice_on').toggleClass('hottext_choice_off');}}});},setResponse:function(values){var ctx=this;if(typeof(values)==='string'&&values!=''){$('#'+ctx.id+" #hottext_choice_"+values).addClass('hottext_choice_on').removeClass('hottext_choice_off');}else if(typeof(values)==='object'){for(var i in values){var value=values[i];if(typeof(value)==='string'&&value!=''){$('#'+ctx.id+" #hottext_choice_"+value).addClass('hottext_choice_on').removeClass('hottext_choice_off');}}}},getResponse:function(){return this.resultCollector.hottext();}});
QtiWidget.DefaultWidget.InlineChoiceInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){},setResponse:function(values){if(values){var value=values;if(typeof(value)==='string'&&value!==''){$('#'+this.id+" option[value='"+value+"']").attr('selected',true);}}},getResponse:function(){return this.resultCollector.inline_choice();}});
QtiWidget.DefaultWidget.MatchInteraction=QtiWidget.DefaultWidget.Widget.extend({init:function(interaction){this._super(interaction);this.associations=[];this.options.matchMaxes={};for(var i=0;i<2;i++){var set=interaction.getChoices(i);for(var serial in set){var choice=set[serial];this.options.matchMaxes[choice.attr('identifier')]={'matchMax':parseInt(choice.attr('matchMax')),'matchGroup':[],'current':0}}}},render:function(){var ctx=this;$('#'+ctx.id+" .choice_list:last").addClass('choice_list_cols');var cols=new Array();$('#'+ctx.id+" .choice_list_cols li").each(function(){cols.push(this.id);});$('#'+ctx.id+" .choice_list:first").addClass('choice_list_rows');var rows=new Array();$('#'+ctx.id+" .choice_list_rows li").each(function(){rows.push(this.id);});$('#'+ctx.id+" .choice_list_cols").after("<div class='match_node_container'></div>");$('#'+ctx.id+" .match_node_container").height(parseInt($('#'+ctx.id+" .choice_list_rows").height()));$('#'+ctx.id+" .match_node_container").css({'left':$('#'+ctx.id+" .choice_list_rows").width()});var maxHeight=25;$('#'+ctx.id+" .choice_list_cols li").each(function(){var height=parseInt($(this).height());if(height>maxHeight){maxHeight=height;}});$('#'+ctx.id+" .choice_list_cols li").each(function(){var li=$(this);li.css('width',li.width()+5);var myDiv=$("<div />").css({'width':li.width(),'height':maxHeight+'px','border':li.css('border')});li.css('height','25px');$(this).wrapInner(myDiv);});$('#'+ctx.id+" .prompt").css('margin-bottom',(maxHeight-20)+'px');var i=0;var currentHeight=0;while(i<rows.length){var xnode='xnode_'+rows[i];var rowHeight=parseFloat($("#"+rows[i]).height());var j=0;while(j<cols.length){var ynode='ynode_'+cols[j];var node_id='match_node_'+i+'_'+j;$('#'+ctx.id+" .match_node_container").append("<div id='"+node_id+"' class='match_node "+xnode+" "+ynode+"'>&nbsp;</div>");var left=0;if(j>0){var p=$("#"+'match_node_'+i+'_'+(j-1)).position();left=parseInt(p.left)+parseInt($("#"+'match_node_'+i+'_'+(j-1)).width())+(12);}
var colWidth=parseFloat($("#"+cols[j]).width());$('#'+ctx.id+" #"+node_id).css({'top':((currentHeight)+(i*2))+'px','left':left+'px','width':colWidth+'px','height':rowHeight+'px'});j++;}
currentHeight+=rowHeight;i++;}
$('#'+ctx.id+" .match_node").click(function(){ctx.selectNode($(this));});},setResponse:function(values){if(typeof(values)==='object'){for(var i in values){var value=values[i];if(value['0']&&value['1']){var row=value['0'];var col=value['1'];this.selectNode($('#'+this.id+" .match_node.xnode_"+row+".ynode_"+col));}}}},getResponse:function(){return this.resultCollector.match();},selectNode:function(jElement){var ctx=this;if(jElement.hasClass('tabActive')){ctx.deactivateNode(jElement);}
else{if(this.associations.length<ctx.options['maxAssociations']||ctx.options['maxAssociations']==0){var nodeXY=this.getNodeXY(jElement);var rowMatch=ctx.options["matchMaxes"][nodeXY.xnode.id]['matchMax'];if(rowMatch==1){$('#'+ctx.id+" ."+nodeXY.xnode['class']).each(function(){ctx.deactivateNode($(this));});}
else if(rowMatch>1){var rowMatched=$('#'+ctx.id+" ."+nodeXY.xnode['class']+".tabActive").length;if(rowMatched>=rowMatch){jElement.effect("highlight",{color:'#B02222'},1000);return false;}}
var colMatch=ctx.options["matchMaxes"][nodeXY.ynode.id]['matchMax'];if(colMatch==1){$("."+nodeXY.ynode['class']).each(function(){ctx.deactivateNode($(this));});}
else if(colMatch>1){var colMatched=$('#'+ctx.id+" ."+nodeXY.ynode['class']+".tabActive").length;if(colMatched>=colMatch){jElement.effect("highlight",{color:'#B02222'},1000);return false;}}
jElement.addClass('tabActive');this.associations.push(jElement.attr('id'));}}},deactivateNode:function(jElement){jElement.removeClass('tabActive');for(var i=0;i<this.associations.length;i++){if(this.associations[i]==jElement.attr('id')){this.associations.splice(i,1);}}},getNodeXY:function(jElement){var x=null;var y=null;var classes=jElement.attr('class').split(' ');for(i in classes){if(/^xnode_/.test(classes[i])){x={'id':classes[i].replace('xnode_',''),'class':classes[i]};}
else if(/^ynode_/.test(classes[i])){y={'id':classes[i].replace('ynode_',''),'class':classes[i]};}
if(x!==null&&y!==null){break;}}
return{'xnode':x,'ynode':y};}});
QtiWidget.DefaultWidget.MediaInteraction=QtiWidget.DefaultWidget.Widget.extend({init:function(interaction,context){this._super(interaction,context);var autostart=interaction.attr('autostart')?interaction.attr('autostart'):false;var context={'pluginPath':context.pluginPath||'','playerOptions':{'loop':interaction.attr('loop')?interaction.attr('loop'):false,'maxPlays':interaction.attr('maxPlays')?interaction.attr('maxPlays'):false,'autostart':autostart,'features':['current','duration','volume'],'clickToPlayPause':false,'success':function(media,dom){$(dom).parent('div.mejs-mediaelement').siblings('div.mejs-layers').find('div.mejs-overlay-button').one('mousedown',function(){media.play();});var disablePlay=function(){media.addEventListener('pause',function(){media.play();});$(dom).parent('div.mejs-mediaelement').siblings('div.mejs-controls').find('div.mejs-playpause-button').remove();if(!$(dom).siblings('div.mejs-youtube-overlay').length){var w=$('#'+media.id).width();var h=$('#'+media.id).height();$('<div class="mejs-youtube-overlay"></div>').insertAfter(dom).css('width',w).css('height',h).on('click',function(e){e.preventDefault();e.stopPropagation();e.returnValue=false;return false;});}};media.addEventListener('play',disablePlay);}}}
if(!context.playerOptions.autostart){context.playerOptions.features.unshift('playpause');}
this.objectWidget=new QtiWidget.DefaultWidget.Object(interaction.getObject(),context);},render:function(){this.objectWidget.render();},setResponse:function(values){this.objectWidget.playCount(parseInt(values));},getResponse:function(){return{"identifier":this.options.responseIdentifier,"value":this.objectWidget.playCount()};}});
QtiWidget.DefaultWidget.OrderInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){var ctx=this;var suffixe="";if(ctx.options.orientation=="horizontal"){$('#'+ctx.id+" .qti_choice_list").removeClass("qti_choice_list").addClass("qti_choice_list_horizontal");var sortableOptions={placeholder:'sort-placeholder',axis:'x',containment:'#'+ctx.id,tolerance:'pointer',forcePlaceholderSize:true,opacity:0.8,start:function(event,ui){$('#'+ctx.id+" .sort-placeholder").width($("#"+ui.helper[0].id).width()+4);$('#'+ctx.id+" .sort-placeholder").height($("#"+ui.helper[0].id).height()+4);$("#"+ui.helper[0].id).css("top","-4px");},beforeStop:function(event,ui){$("#"+ui.helper[0].id).css("top","0");}};suffixe="_horizontal";}else{var sortableOptions={placeholder:'sort-placeholder',axis:'y',containment:'#'+ctx.id,tolerance:'pointer',forcePlaceholderSize:true,opacity:0.8,start:function(event,ui){$('#'+ctx.id+" .sort-placeholder").width($("#"+ui.helper[0].id).width()+4);$('#'+ctx.id+" .sort-placeholder").height($("#"+ui.helper[0].id).height()+4);$("#"+ui.helper[0].id).css("top","-4px");},beforeStop:function(event,ui){$("#"+ui.helper[0].id).css("top","0");}};}
if(ctx.options.orientation=="horizontal"){$('#'+ctx.id).append("<div class='sizeEvaluator'></div>");$('#'+ctx.id+" .sizeEvaluator").css("font-size",$('#'+ctx.id+" .qti_choice_list_horizontal li").css("font-size"));var containerWidth=0;$('#'+ctx.id+" .qti_choice_list_horizontal li").each(function(){$('#'+ctx.id+" .sizeEvaluator").text($(this).text());var liSize=$('#'+ctx.id+" .sizeEvaluator").width();var liChildren=$(this).children();if(liChildren.length>0){$.each(liChildren,function(index,elt){liSize+=$(elt).width();});}
$(this).width(liSize+10);containerWidth+=liSize+20;});if(parseInt($('#'+ctx.id).width())<containerWidth){$('#'+ctx.id).width(containerWidth+'px').css({'overflow-x':'auto'});}
$('#'+ctx.id+" .sizeEvaluator").remove();}
$('#'+ctx.id+" .qti_choice_list"+suffixe).sortable(sortableOptions);$('#'+ctx.id+" .qti_choice_list"+suffixe).disableSelection();$('#'+ctx.id).append("<div class='breaker'> </div>");},setResponse:function(values){var ctx=this;if(typeof(values)==='object'){var list=new Array();for(var i in values){var value=values[i];if(typeof(value)==='string'&&value!=''){list.push($('#'+ctx.id+" ul.qti_choice_list li#"+value));}}
if(list.length===$('#'+ctx.id+" ul.qti_choice_list li").length&&list.length>0){$('#'+ctx.id+" ul.qti_choice_list").empty();for(var i in list){$('#'+ctx.id+" ul.qti_choice_list").append(list[i]);}}}},getResponse:function(){return this.resultCollector.order();}});
QtiWidget.DefaultWidget.SelectPointInteraction=QtiWidget.DefaultWidget.GraphicInteraction.extend({countChoices:0,render:function(){var ctx=this;var imageHeight=parseInt(ctx.options.imageHeight);var imageWidth=parseInt(ctx.options.imageWidth);var itemHeight=parseInt($('#'+ctx.id).height());$('#'+ctx.id).css("height",itemHeight+imageHeight);if(isNaN(imageHeight)||isNaN(imageWidth)){$('#'+ctx.id).append("<div class='img-loader' style='visibility:hidden;'></div>");var $loadedImg=$("<img src='"+ctx.options.imagePath+"' />");$loadedImg.load(function(){var imageWidth=parseInt($(this).width());var imageHeight=parseInt($(this).height());$('#'+ctx.id+' .img-loader').remove();ctx.createArea(imageWidth,imageHeight,itemHeight);});$('#'+ctx.id+' .img-loader').append($loadedImg);}
else{ctx.createArea(imageWidth,imageHeight,itemHeight);}
$('#'+ctx.id+" .svg-container").bind("click",function(e){var relativeXmouse=e.pageX-5;var relativeYmouse=e.pageY-5;ctx.setPoint($(this),relativeXmouse,relativeYmouse);});},setResponse:function(values){var $containerArea=$('#'+this.id+" .svg-container");if(typeof(values)==='object'){for(var i in values){var value=values[i];if(typeof(value)==='object'){if(value['0']&&value['1']){this.setPoint($containerArea,$containerArea.offset().left+parseInt(value['0']),$containerArea.offset().top+parseInt(value['1']));}}}}},getResponse:function(){return this.resultCollector.select_point();},createArea:function(imageWidth,imageHeight,itemHeight){$('#'+this.id).append("<div class='svg-container'></div>");var paper=Raphael($('#'+this.id+' .svg-container')[0],imageWidth,itemHeight+imageHeight);paper.image(this.options.imagePath,0,0,imageWidth,imageHeight);},setPoint:function($jContainer,x,y){var ctx=this;var maxChoices=parseInt(ctx.options.maxChoices);if(ctx.countChoices>=maxChoices&&maxChoices!==0){return;}
ctx.countChoices++;var offset=$jContainer.offset();var point={'x':parseInt(x-offset.left),'y':parseInt(y-offset.top)};var responseId=ctx.resultCollector.append(point);$jContainer.append('<span class="select_point_cross"/>').find('span:last').css({position:"absolute",top:y+'px',left:x+'px',"cursor":"pointer"}).on('click',function(e){ctx.countChoices--;$(this).remove();ctx.resultCollector.remove(responseId);return false;});}});
QtiWidget.DefaultWidget.SliderInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){var ctx=this;$('#'+ctx.id).append("<input type='hidden' id='"+ctx.id+"_qti_slider_value' />").append("<div class='qti_slider'></div>").append("<div class='qti_slider_label'></div>");ctx.$sliderVal=$('#'+ctx.id+"_qti_slider_value");var containerWidth=parseInt($('#'+ctx.id).width());var min=parseInt(ctx.options['lowerBound']);var max=parseInt(ctx.options['upperBound']);var step=1;if(ctx.options.step!=undefined||ctx.options.step!==null){step=parseInt(ctx.options.step)?parseInt(ctx.options.step):0.001;}
var stepLabel=(ctx.options['stepLabel']===true||ctx.options['stepLabel']==='true');stepLabel=false;var reverse=(ctx.options['reverse']===true||ctx.options['reverse']==='true');var orientation='horizontal';if($.inArray(ctx.options['orientation'],['horizontal','vertical'])>-1){orientation=ctx.options['orientation'];}
var sliderSize=((max-min)/step)*20;if(orientation==='horizontal'){if(sliderSize>containerWidth){sliderSize=containerWidth-20;}
$('#'+ctx.id).addClass('qti_slider_horizontal');$('#'+ctx.id+' .qti_slider').width(sliderSize+'px');$('#'+ctx.id+' .qti_slider_label').width((sliderSize+40)+'px');}else{var maxHeight=300;if(sliderSize>maxHeight){sliderSize=maxHeight;}
$('#'+ctx.id).addClass('qti_slider_vertical');$('#'+ctx.id+' .qti_slider').height(sliderSize+'px');$('#'+ctx.id+' .qti_slider_label').height((sliderSize+20)+'px');}
if(!stepLabel){var displayMin=min;var displayMax=max;if(reverse){displayMin=max;displayMax=min;}
$('#'+ctx.id+' .qti_slider_label').append("<span class='slider_min'>"+displayMin+"</span>").append("<span class='slider_cur highlight'>"+displayMin+"</span>").append("<span class='slider_max'>"+displayMax+"</span>");}else{$('#'+ctx.id).addClass('qti_slider_step');var stepSpacing=20;var displayRatio=1;if((max*20)>sliderSize){do{stepSpacing=(sliderSize/(max/displayRatio));displayRatio++;}while(stepSpacing<25);displayRatio--;}
var i=0;var stepWidth=(step<1)?1:step;for(i=min;i<=max;i+=(stepWidth*displayRatio)){var displayIndex=i;if(reverse){displayIndex=max+min-i;}
var $iStep=$("<span class=\"_"+displayIndex+"\">"+displayIndex+"</span>");if(orientation==='horizontal'){$iStep.css({left:((i/displayRatio)*stepSpacing)+5+'px'});}
else{$iStep.css({top:((i/displayRatio)*stepSpacing)+5+'px'});}
$('#'+ctx.id+' .qti_slider_label').append($iStep);}
i-=(step*displayRatio);if(i!=max){if(i<max){$('#'+ctx.id+' .qti_slider_label span:last').remove();}
var displayMax=max;if(reverse){displayMax=min;}
var $iStep=$("<span>"+displayMax+"</span>");if(orientation==='horizontal'){$iStep.css({right:'0px'});}
else{$iStep.css({bottom:'0px'});}
$('#'+ctx.id+' .qti_slider_label').append($iStep);}}
var val=min;if((reverse&&orientation==='horizontal')||(!reverse&&orientation==='vertical')){val=max;}
ctx.slider=$('#'+ctx.id+' .qti_slider').slider({value:((reverse&&orientation==='horizontal')||(!reverse&&orientation==='vertical'))?(max+min)-val:val,min:min,max:max,step:step,orientation:orientation,animate:'fast',slide:function(event,ui){var val=ui.value;if((reverse&&orientation==='horizontal')||(!reverse&&orientation==='vertical')){val=(max+min)-ui.value;}
val=Math.round(val*1000)/1000;ctx.$sliderVal.val(val);ctx.highlight(val);}});ctx.$sliderVal.val(val);ctx.highlight(val);},setResponse:function(values){this.setValue(values);},getResponse:function(){return this.resultCollector.slider();},setValue:function(value){value=value+0;this.$sliderVal.val(value);this.slider.slider('value',value);this.highlight(value);},highlight:function(value){if(!$('#'+this.id).hasClass('qti_slider_step')){$('#'+this.id+' '+'.slider_cur').text(value);}else{$('#'+this.id+' .qti_slider_label span').removeClass('highlight');$('#'+this.id+' .qti_slider_label span._'+value).addClass('highlight');}}});
QtiWidget.DefaultWidget.TextEntryInteraction=QtiWidget.DefaultWidget.StringInteraction.extend({render:function(){if(this.options['expectedLength']){var length=parseInt(this.options['expectedLength']);$('#'+this.id).css('width',length+'em');}
this._super();}});
QtiWidget.DefaultWidget.UploadInteraction=QtiWidget.DefaultWidget.Widget.extend({render:function(){},setResponse:function(values){},getResponse:function(){}});