define("taoItems/controller/routes",[],function(){return{Items:{deps:"controller/items"},ItemPreview:{actions:{index:"controller/preview/itemRunner"}}}}),define("taoItems/controller/items",["jquery","i18n","helpers","uiBootstrap","module"],function(e,t,n,i,r){function o(n){var i=n?t("Authoring")+": "+n:t("Authoring"),r=n?t("Preview")+": "+n:t("Preview");e("a#items_authoring").text(i).attr("title",i),e("a#items_preview").text(r).attr("title",r)}var s=i.tabs,a=n.getTabIndexByName("items_authoring"),c=n.getTabIndexByName("items_preview");return{start:function(){var e=r.config();e.uri&&e.classUri?(e.isAuthoringEnabled===!0&&"authoring"!==e.action&&(s.tabs("url",a,e.authoringUrl),s.tabs("enable",a)),e.isPreviewEnabled===!0&&"preview"!==e.action&&(s.tabs("url",c,e.previewUrl),s.tabs("enable",c)),e.label&&o(e.label)):(o(),"authoring"!==e.action&&s.tabs("disable",a),"preview"!==e.action&&s.tabs("disable",c)),e.reload&&i.initTrees(),e.message&&n.createMessage(e.message)}}}),define("serviceApi/ServiceApi",["jquery","urlParser","iframeResizer"],function(e,t){function n(e,t,n,i,r){this.baseUrl=e,this.parameters=t,this.connected=!1,this.serviceCallId=n,this.state=i,this.userService=r,this.onFinishCallback,this.onKillCallback,this.onDisplayChangeCallback}return n.SIG_SUCCESS=0,n.SIG_ERROR=1,n.prototype.loadInto=function(n,i){var r=this,o=e(n),s=this.getCallUrl(),a=new t(s).checkCORS();o.one("load",function(){e(document).on("serviceready",function(){r.connect(n,i)})}).on("load.cors",function(){a===!0&&(n.contentWindow.__knownParent__=!0)}),o.attr("src",s)},n.prototype.connect=function(e,t){this.connected===!1&&e.contentWindow&&"function"==typeof e.contentWindow.onServiceApiReady&&(e.contentWindow.onServiceApiReady(this),this.connected=!0,"function"==typeof t&&t())},n.prototype.getCallUrl=function(){var t=this.parameters||{};return t.serviceCallId=this.serviceCallId,this.baseUrl+"?"+e.param(t)},n.prototype.getUserPropertyValues=function(e,t){this.userService.get(e,t)},n.prototype.getServiceCallId=function(){return this.serviceCallId},n.prototype.getState=function(){return this.state.get()},n.prototype.setState=function(e,t){return this.state.set(e,t)},n.prototype.getParameter=function(e){return"undefined"!=typeof this.parameters[e]?this.parameters[e]:null},n.prototype.onFinish=function(e){this.onFinishCallback=e},n.prototype.onKill=function(e){this.onKillCallback=e},n.prototype.kill=function(e){"function"==typeof this.onKillCallback?this.onKillCallback(e):e(0)},n.prototype.finish=function(e){"function"==typeof this.onFinishCallback&&this.onFinishCallback(e)},n}),define("serviceApi/PseudoStorage",[],function(){function e(){}return e.prototype.get=function(e){return"function"==typeof e&&e(null),null},e.prototype.set=function(e,t){"function"==typeof t&&t()},e}),define("serviceApi/UserInfoService",["jquery"],function(e){function t(e,t){this.data=t,this.requestUrl=e}return t.prototype.get=function(t,n){this.data.hasOwnProperty(t)?"function"==typeof n&&n(this.data[t]):e.ajax({url:this.requestUrl,data:{property:t},type:"post",dataType:"json",success:function(e,n){return function(i){for(key in i.data)e.data[key]=i.data[key];"function"==typeof n&&n(e.data[t])}}(this,n)})},t}),define("taoItems/runtime/ItemServiceImpl",["jquery"],function(e){function t(t){this.itemId=t.itemId,this.serviceApi=t.serviceApi,this.resultApi=t.resultApi||null,this.params=t.params||{},this.responses={},this.scores={},this.events={},this.connected=!1;var n=this.serviceApi.getState(),i="undefined"==typeof n||null===n?{}:e.parseJSON(n);this.stateVariables="object"==typeof i?i:{},this.beforeFinishCallbacks=[]}return t.prototype.connect=function(e){this.connected===!1&&e.contentWindow&&(e.contentWindow.itemApi=this,"function"==typeof e.contentWindow.onItemApiReady&&(e.contentWindow.onItemApiReady(this),this.connected=!0))},t.prototype.saveResponses=function(e){for(var t in e)this.responses[t]=e[t]},t.prototype.traceEvents=function(e){for(var t in e)this.events[t]=e[t]},t.prototype.saveScores=function(e){for(var t in e)this.scores[t]=e[t]},t.prototype.getUserPropertyValues=function(e,t){this.serviceApi.getUserPropertyValues(e,t)},t.prototype.beforeFinish=function(e){this.beforeFinishCallbacks.push(e)},t.prototype.finish=function(){for(var e=this,t=0;t<this.beforeFinishCallbacks.length;t++)this.beforeFinishCallbacks[t]();this.submit(function(){e.serviceApi.finish()})},t.prototype.submit=function(e){var t=this;this.serviceApi.setState(JSON.stringify(t.stateVariables),function(){t.resultApi?t.resultApi.submitItemVariables(t.itemId,t.serviceApi.getServiceCallId(),t.responses,t.scores,t.events,t.params,e):e()})},t.prototype.onKill=function(e){this.serviceApi.onKill(e)},t.prototype.getVariable=function(e,t){"function"==typeof t&&t(this.stateVariables[e]||null)},t.prototype.setVariable=function(e,t){this.stateVariables[e]=t},t}),define("taoItems/preview-console",["jquery"],function(e){function t(e){var t={},n=e.split("&");for(var i in n)if("string"==typeof n[i]){var r=n[i].split("=");if(2==r.length)if(/\[\]$/.test(r[0])){var o=r[0].replace(/\[\]$/,"");"undefined"==typeof t[o]&&(t[o]=[]),t[o].push(r[1])}else t[r[0]]=r[1]}return t}return{setup:function(){var n=new Date,i=e("#preview-console",window.top.document),r=e(".console-control",i),o=e(".console-content",i),s=e(".console-content > ul",i);i.bind("updateConsole",function(e,t,i){var r=n.getHours(),o=n.getMinutes(),a=n.getSeconds(),c=(r>10?r:"0"+r)+":"+(o>10?o:"0"+o)+":"+(a>10?a:"0"+a);s.append("<li><b>["+c+"] "+t+"</b>: "+i+"</li>")}),e(".ui-icon-circle-close",r).on("click",function(e){e.preventDefault(),i.hide()}),e(".ui-icon-trash",r).on("click",function(e){e.preventDefault(),s.empty()}),e(".toggler",r).on("click",function(t){t.preventDefault(),o.toggle(),e(this).toggleClass("ui-icon-circle-minus").toggleClass("ui-icon-circle-plus")}),e("body").ajaxSuccess(function(n,r,o){if(/LegacyPreviewApi/.test(o.url)){var s="";if(/save$/.test(o.url)){var a=t(decodeURIComponent(o.data));for(var c in a)"token"!==c&&(s+="<br />"+c+" = "+a[c]);""!==s&&(s+="<br />",i.trigger("updateConsole",["push data",s]))}else if(/traceEvents$/.test(o.url)){var a=t(decodeURIComponent(o.data));if(a.events){for(var l in a.events)try{var u=e.parseJSON(a.events[l]);s+="<br />"+u.type+" on element "+u.name,"noID"!==u.id&&(s+="[id="+u.id+"]")}catch(p){}s+="<br />",i.trigger("updateConsole",["trace events",s])}}else if(/saveContext$/.test(o.url)){var a=t(decodeURIComponent(o.data));for(c in a)"token"!==c&&(s+="<br />"+c+" = "+a[c]);s+="<br />",i.trigger("updateConsole",["save context",s])}else if(/retrieveContext$/.test(o.url)){var a=t(decodeURIComponent(o.data));for(c in a)"token"!==c&&(s+="<br />"+c+" = "+a[c]);s+="<br />",i.trigger("updateConsole",["retrieved context",s])}else if(/evaluate$/.test(o.url)){var a=t(decodeURIComponent(o.data));if(a.data){try{var f=e.parseJSON(a.data);for(c in f)s+="<br />"+f[c].identifier+" = "+f[c].value}catch(p){}s+="<br />",i.trigger("updateConsole",["sent answers",s])}}else s="<br />"+o.type+" "+o.url+" ? "+decodeURIComponent(o.data)+" => "+r.responseText,i.trigger("updateConsole",["remote request",s])}})}}}),define("taoItems/controller/preview/itemRunner",["module","jquery","lodash","serviceApi/ServiceApi","serviceApi/PseudoStorage","serviceApi/UserInfoService","taoItems/runtime/ItemServiceImpl","taoItems/preview-console","urlParser","iframeResizer"],function(e,t,n,i,r,o,s,a,c,l){var u={start:function(u){var p=n.merge(e.config(),u||{});if(p.previewUrl){a.setup();var f=n.defaults(p.resultServer,{module:"taoResultServer/ResultServerApi",endpoint:"",params:{}});require([f.module],function(e){var n=new e(f.endpoint,f.params),a=new i(p.previewUrl,{},"preview",new r,new o(p.userInfoServiceRequestUrl,{})),u=new s({serviceApi:a,resultApi:n}),d=new c(a.getCallUrl()),v=d.checkCORS();d.addParam("clientConfigUrl",p.clientConfigUrl);var h=t("#preview-container");l.autoHeight(h,"body",10),h.on("load",function(){var e=this;u.connect(e),v===!0&&(e.contentWindow.__knownParent__=!0),t(document).on("itemready",function(){u.connect(e)})}),t("#preview-container").attr("src",d.getUrl()),t("#finishButton").click(function(){u.finish()})})}}};return u}),define("taoItems/controller/runtime/itemRunner",["jquery","lodash","iframeResizer","iframeNotifier","urlParser"],function(e,t,n,i,r){var o={start:function(o){var s=e('<iframe id="item-container" class="toolframe" frameborder="0" style="width:100%;height:100%;overflow:hidden" scrolling="no"></iframe>');s.appendTo("body");var a=o.itemId,c=o.itemPath,l=t.defaults(o.resultServer,{module:"taoResultServer/ResultServerApi",params:{}}),u=t.defaults(o.itemService,{module:"taoItems/runtime/ItemServiceImpl",params:{}}),p=o.clientConfigUrl;require([u.module,l.module],function(o,f){var d=new f(l.endpoint,l.params);window.onServiceApiReady=function(l){var f=new o(t.merge({serviceApi:l,itemId:a,resultApi:d},{params:u.params})),v=new r(c),h=v.checkCORS();v.addParam("clientConfigUrl",p),n.autoHeight(s,"body",10),e(document).on("itemloaded",function(){i.parent("serviceloaded")}),e(document).on("itemready",function(){f.connect(s[0])}),s.on("load",function(){f.connect(s[0]),h===!0&&(this.contentWindow.__knownParent__=!0)}),s.attr("src",v.getUrl())},i.parent("serviceready")})}};return o});