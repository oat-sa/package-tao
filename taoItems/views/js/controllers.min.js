define("taoItems/controller/routes",[],function(){"use strict";return{Items:{deps:"controller/items/action",actions:{editItem:"controller/items/edit"}},ItemPreview:{actions:{index:"controller/preview/itemRunner"}}}}),define("json!taoItems/preview/resources/device-list.json",function(){return{tablets:{"193986c3715c81838870f908fa98d69a":{label:"Amazon Kindle Fire HDX 7″",width:960,height:600},"4e8eafab11aad1486992d7ee2c8c16ca":{label:"Apple iPad",width:1024,height:768},"5aac2932d9ad00d6d8a1604b8f9e4e8d":{label:"Google Nexus 10, Motorola Xoom, Xyboard",width:1280,height:800},"9805d9753ad08c7630a9ee5418aa6c6c":{label:"Google Nexus 7",width:966,height:604},d4a431cedf4705d6bf2cba6d5788378b:{label:"Samsung Galaxy Tab 7.7, 8.9, 10.1",width:1280,height:800}},phones:{"1b89338531ef0155c8d6abc2ac02c81a":{label:"Apple iPhone 3GS",width:320,height:480,scaleFactor:1,dpWidth:320,dpHeight:480},"3f89da99d84214cde7df87ebe0699a6f":{label:"Apple iPhone 4",width:640,height:960,scaleFactor:2,dpWidth:320,dpHeight:1920},"0d36971a5b98b367f54ced708c9af849":{label:"Apple iPhone 5",width:640,height:1136,scaleFactor:2,dpWidth:320,dpHeight:2272},"026beffcc051af995660ebdede986ace":{label:"BlackBerry Z10",width:768,height:1280,scaleFactor:2,dpWidth:384,dpHeight:2560},fd2dd53e667d6d49e4fa73356fa941dd:{label:"BlackBerry Z30",width:720,height:1280,scaleFactor:2,dpWidth:360,dpHeight:2560},"707584c1ae17d9b5b2cbe8603c91c147":{label:"Google Nexus 4",width:768,height:1280,scaleFactor:2,dpWidth:384,dpHeight:2560},"91823264de952e7f2347e07db5c4058b":{label:"Google Nexus 5",width:1080,height:1920,scaleFactor:3,dpWidth:360,dpHeight:5760},cd69817a6e147e8a4677389e56fcf568:{label:"Google Nexus S",width:480,height:800,scaleFactor:1.5,dpWidth:320,dpHeight:1200},"75994faa6a38e31e99b53fcd75534a33":{label:"HTC Evo, Touch HD, Desire HD, Desire",width:480,height:800,scaleFactor:1.5,dpWidth:320,dpHeight:1200},"0cab4dfccdfc880687cb608cfe4159db":{label:"HTC One X, EVO LTE",width:720,height:1280,scaleFactor:2,dpWidth:360,dpHeight:2560},c4ff41fcba24d74fc21dc3490ca1edc9:{label:"HTC Sensation, Evo 3D",width:540,height:960,scaleFactor:1.5,dpWidth:360,dpHeight:1440},fa969a5e0dd2de53700eeee4ba4ba142:{label:"LG Optimus 2X, Optimus 3D, Optimus Black",width:480,height:800,scaleFactor:1.5,dpWidth:320,dpHeight:1200},"33c4f9364e295ec03531f3a3425819cf":{label:"LG Optimus G",width:768,height:1280,scaleFactor:2,dpWidth:384,dpHeight:2560},bc47f5275f0efd56fee52d43a8082981:{label:"LG Optimus LTE, Optimus 4X HD",width:720,height:1280,scaleFactor:1.7,dpWidth:424,dpHeight:2176},"0732887e6e324fd10777b735520a34cf":{label:"LG Optimus One",width:320,height:480,scaleFactor:1.5,dpWidth:213,dpHeight:720},"2e38a78364f09d0da0e9e1a3a68e7fb0":{label:"Motorola Defy, Droid, Droid X, Milestone",width:480,height:854,scaleFactor:1.5,dpWidth:320,dpHeight:1281},bd4b78dddc7c9625a4141a1b1ddabb87:{label:"Motorola Droid 3, Droid 4, Droid Razr, Atrix 4G, Atrix 2",width:540,height:960,scaleFactor:1,dpWidth:540,dpHeight:960},"3bf1edf21cfa81006183d2b02974c84e":{label:"Motorola Droid Razr HD",width:720,height:1280,scaleFactor:1,dpWidth:720,dpHeight:1280},ab5a352e0e016b97dac986f06c394f55:{label:"Nokia C5, C6, C7, N97, N8, X7",width:360,height:640,scaleFactor:1,dpWidth:360,dpHeight:640},"4826fb7d7257aeaac992ce699df41b3c":{label:"Nokia Lumia 7X0, Lumia 8XX, Lumia 900, N800, N810, N900",width:480,height:800,scaleFactor:1.5,dpWidth:320,dpHeight:1200},"0a691ab20add7c432200f8fa6527b488":{label:"Samsung Galaxy Note",width:800,height:1280,scaleFactor:2,dpWidth:400,dpHeight:2560},"9c23ee31be29960fbac9e9bbfc2fc7b0":{label:"Samsung Galaxy Note 3",width:1080,height:1920,scaleFactor:2,dpWidth:540,dpHeight:3840},"92177c0508c1d73905a58e2338f2a81f":{label:"Samsung Galaxy Note II",width:720,height:1280,scaleFactor:2,dpWidth:360,dpHeight:2560},"5222b8866dc4cc606725e16ffcc0a783":{label:"Samsung Galaxy S III, Galaxy Nexus",width:720,height:1280,scaleFactor:2,dpWidth:360,dpHeight:2560},"37c1541e2bd55cfd0f4073b0ccdf68b3":{label:"Samsung Galaxy S, S II, W",width:480,height:800,scaleFactor:1.5,dpWidth:320,dpHeight:1200},"2f7f64b7dda0144907ff300e83eed465":{label:"Samsung Galaxy S4",width:1080,height:1920,scaleFactor:3,dpWidth:360,dpHeight:5760},"9c24f9057744dad56043702a9703127f":{label:"Sony Xperia S, Ion",width:720,height:1280,scaleFactor:2,dpWidth:360,dpHeight:2560},"0a8b2732a016a9395c3af5f12dd9c0da":{label:"Sony Xperia Sola, U",width:480,height:854,scaleFactor:1,dpWidth:480,dpHeight:854},"5a153d7f53d82dcb0801f041574a6a43":{label:"Sony Xperia Z, Z1",width:1080,height:1920,scaleFactor:3,dpWidth:360,dpHeight:5760}},screens:{"9e523ae15b61dc766f5c818726881ecf":{label:"1920 × 1080",width:1920,height:1080,dpWidth:1920,dpHeight:1080,scaleFactor:1},"07769cd8d0a7d09818b2f0b018042fb7":{label:"1366 × 768",width:1366,height:768,dpWidth:1366,dpHeight:768,scaleFactor:1},"72d5478a24194f98b9378e8e0fd65737":{label:"1280 × 1024",width:1280,height:1024,dpWidth:1280,dpHeight:1024,scaleFactor:1},b7a6dd5900cc72e61f0d3479c7e314ec:{label:"1280 × 800",width:1280,height:800,dpWidth:1280,dpHeight:800,scaleFactor:1},"43193b0ff671a37d8232ab664190a125":{label:"1024 × 768",width:1024,height:768,dpWidth:1024,dpHeight:768,scaleFactor:1},c29e48814af5443ff5688d9e967ce917:{label:"800 × 600",width:800,height:600,dpWidth:800,dpHeight:600,scaleFactor:1}}}
}),define("tpl!taoItems/preview/tpl/preview",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){function program1(depth0,data){var stack1,helper,buffer="";return buffer+='\n                        <option value="',(helper=helpers.value)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.value,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'" ',stack1=helpers["if"].call(depth0,depth0&&depth0.selected,{hash:{},inverse:self.noop,fn:self.program(2,program2,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+=">",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</option>\n                        "
}function program2(){return'selected="selected"'}function program4(depth0,data){var stack1,helper,buffer="";return buffer+='\n                        <option value="',(helper=helpers.value)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.value,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'" data-value="',(helper=helpers.dataValue)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.dataValue,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'" ',stack1=helpers["if"].call(depth0,depth0&&depth0.selected,{hash:{},inverse:self.noop,fn:self.program(2,program2,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+=">",(helper=helpers.label)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.label,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"</option>\n                        "
}this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,options,buffer="",functionType="function",escapeExpression=this.escapeExpression,self=this,helperMissing=helpers.helperMissing;return buffer+='<div class="preview-overlay tao-scope overlay preview-',(helper=helpers.previewType)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.previewType,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+' item-no-print"\n     style="overflow-x: hidden;display:none">\n    <div class="preview-container-outer">\n        <form class="preview-utility-bar plain">\n            <div class="preview-utility-bar-inner grid-row">\n\n                <div class="col-4">\n                    <input type="hidden" value="" data-value="" class="standard-device-selector preview-device-selector" data-target="standard">\n                    <select class="preview-type-selector">\n                        ',stack1=helpers.each.call(depth0,depth0&&depth0.previewTypes,{hash:{},inverse:self.noop,fn:self.program(1,program1,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n                    </select>\n                </div>\n                <div class="col-6 standard-only device-type-and-orientation"></div>\n                <div class="col-6 desktop-only device-type-and-orientation">\n                    <select class="desktop-device-selector preview-device-selector" data-target="desktop">\n                        ',stack1=helpers.each.call(depth0,depth0&&depth0.desktopDevices,{hash:{},inverse:self.noop,fn:self.program(4,program4,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n                    </select>\n                </div>\n                <div class="col-6 mobile-only device-type-and-orientation">\n                    <select class="mobile-device-selector preview-device-selector" data-target="mobile">\n                        ',stack1=helpers.each.call(depth0,depth0&&depth0.mobileDevices,{hash:{},inverse:self.noop,fn:self.program(4,program4,data),data:data}),(stack1||0===stack1)&&(buffer+=stack1),buffer+='\n                    </select>\n                    <select tabindex="-1" class="mobile-orientation-selector orientation-selector"\n                            data-target="mobile">\n                        <option value="landscape">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Landscape",options):helperMissing.call(depth0,"__","Landscape",options)))+'</option>\n                        <option value="portrait">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Portrait",options):helperMissing.call(depth0,"__","Portrait",options)))+'</option>\n                    </select>\n                </div>\n                <div class="col-2">\n                    <!--label>\n                        <input type="checkbox"/>\n                        <span class="icon-checkbox"></span>\n                        '+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Scale ",options):helperMissing.call(depth0,"__","Scale ",options)))+'\n                    </label-->\n                        <span class="btn-info small preview-closer rgt">\n                            '+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Close",options):helperMissing.call(depth0,"__","Close",options)))+'\n                            <span class="icon-close r"></span>\n                        </span>\n                </div>\n            </div>\n            <div class="preview-message-box">\n                <div class="feedback-info small">\n                    <span class="icon-info"></span>\n                    '+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"This preview may be scaled to fit your screen. The final rendering may differ.",options):helperMissing.call(depth0,"__","This preview may be scaled to fit your screen. The final rendering may differ.",options)))+'\n                    <a href="#">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Don’t show this again!",options):helperMissing.call(depth0,"__","Don’t show this again!",options)))+'</a>\n                    <span title="'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Remove this message",options):helperMissing.call(depth0,"__","Remove this message",options)))+'" class="icon-close close-trigger"></span>\n                </div>\n            </div>\n        </form>\n        <div class="preview-canvas">\n\n            <div class="preview-scale-container">\n                <div class="',(helper=helpers.previewType)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.previewType,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+"-preview-frame preview-outer-frame ",(helper=helpers.previewType)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.previewType,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'-preview-landscape">\n                    <div class="',(helper=helpers.previewType)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.previewType,stack1=typeof helper===functionType?helper.call(depth0,{hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'-preview-container preview-container">\n                        <div class="preview-item-container"></div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <div id="preview-console">\n        <span class="icon-close preview-console-closer" title="'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Close console",options):helperMissing.call(depth0,"__","Close console",options)))+'"></span>\n\n        <div class="preview-console-header grid-row clearfix">\n            <div class="col-12">\n                <button type="button" class="btn-info small rgt" id="preview-submit-button">'+escapeExpression((helper=helpers.__||depth0&&depth0.__,options={hash:{},data:data},helper?helper.call(depth0,"Submit",options):helperMissing.call(depth0,"__","Submit",options)))+'</button>\n            </div>\n        </div>\n        <div class="preview-console-body clear">\n            <ul></ul>\n        </div>\n    </div>\n</div>'
})}),define("taoItems/preview/preview",["jquery","lodash","i18n","util/strPad","json!taoItems/preview/resources/device-list.json","tpl!taoItems/preview/tpl/preview","ui/modal","select2","jquery.cookie"],function($,_,__,strPad,deviceList,previewTpl){"use strict";var overlay,container,typeDependant,$feedbackBox,$console,previewContainerMaxWidth,itemUri,orientation="landscape",previewType="standard",previewTypes={desktop:__("Desktop preview"),mobile:__("Mobile preview"),standard:__("Actual size")},$doc=$(document),$window=$(window),$body=$(document.body),screenSize={width:$window.innerWidth(),height:$window.innerHeight()},maxDeviceSize={width:0,height:0},scaleFactor=1,_getDeviceSelectorData=function(type){var devices="mobile"===type?deviceList.tablets:deviceList.screens,options=[];
return _.forEach(devices,function(value){maxDeviceSize={width:Math.max(maxDeviceSize.width,value.width),height:Math.max(maxDeviceSize.height,value.height)},options.push({value:value.label,label:value.label,dataValue:[value.width,value.height].join(","),selected:previewType===value.label})}),options},_setupTypeDependantElements=function(){typeDependant=overlay.add(overlay.find(".preview-scale-container").find('[class*="'+previewType+'"]'))},_setPreviewType=function(newType){if(newType!==previewType){var re=new RegExp(previewType,"g");typeDependant.each(function(){this.className=this.className.replace(re,newType)}),previewType=newType}},_setOrientation=function(newOrientation){if(newOrientation!==orientation){var re=new RegExp(orientation,"g"),previewFrame=$(".preview-outer-frame")[0];
previewFrame.className=previewFrame.className.replace(re,newOrientation),orientation=newOrientation}},_scale=function(){var $scaleContainer=$(".preview-scale-container"),_scaleFactor="standard"===previewType?1:scaleFactor,containerScaledWidth=$scaleContainer.width()*_scaleFactor,left=(screenSize.width-containerScaledWidth)/2;$scaleContainer.css({left:left,"-webkit-transform":"scale("+_scaleFactor+","+_scaleFactor+")","-ms-transform":"scale("+_scaleFactor+","+_scaleFactor+")",transform:"scale("+_scaleFactor+","+_scaleFactor+")","-webkit-transform-origin":"0 0","-ms-transform-origin":"0 0","transform-origin":"0 0"})},_positionPreview=function(){$(".preview-canvas").css({paddingTop:$(".preview-utility-bar").outerHeight()+5})
},_computeScaleFactor=function(){var scaleValues={x:1,y:1},requiredSize={width:maxDeviceSize.width+150,height:maxDeviceSize.height+275};requiredSize.width>screenSize.width&&(scaleValues.x=screenSize.width/requiredSize.width),requiredSize.height>screenSize.height&&(scaleValues.y=screenSize.height/requiredSize.height),scaleFactor=Math.min(scaleValues.x,scaleValues.y)},_setupDeviceSelectors=function(){var previewDeviceSelectors=overlay.find(".preview-device-selector");previewDeviceSelectors.on("change",function(){for(var sizeSettings,elem=$(this),option="select"===this.nodeName.toLowerCase()?this.options[this.selectedIndex]:this,type=elem.data("target"),val=$(option).data("value").split(","),i=val.length,container=overlay.find("."+type+"-preview-container");i--;)val[i]=parseFloat(val[i]);
return sizeSettings="mobile"===type&&"portrait"===orientation?{width:val[1],height:val[0]}:{width:val[0],height:val[1]},sizeSettings.width===container.width()&&sizeSettings.height===container.height()?!1:(_setPreviewType(type),container.css(sizeSettings),_scale(),void _adaptFrameSize())}),previewDeviceSelectors.each(function(){"select"===this.nodeName.toLowerCase()&&$(this).select2({minimumResultsForSearch:-1})})},_setupOrientationSelectors=function(){$("select.orientation-selector").on("change",function(){var sizeSettings,type=$(this).data("target"),previewFrame=$("."+type+"-preview-frame"),container=previewFrame.find("."+type+"-preview-container"),newOrientation=$(this).val();
return newOrientation===orientation?!1:(sizeSettings={height:container.width(),width:container.height()},container.css(sizeSettings),_scale(),_adaptFrameSize(),void _setOrientation(newOrientation))}).select2({minimumResultsForSearch:-1})},_setupClosers=function(){var $closer=overlay.find(".preview-closer"),$feedbackCloser=$feedbackBox.find(".close-trigger"),$hideForever=$feedbackBox.find("a"),$iframe=$("#preview-iframe");$closer.on("click",function(){overlay.hide(),$iframe.off("load").attr("src","about:blank")}),$doc.keyup(function(e){27===e.keyCode&&$closer.trigger("click")}),$feedbackCloser.on("click",function(){$feedbackBox.hide(),_positionPreview(),_scale()
}),$hideForever.on("click",function(e){e.preventDefault(),$.cookie("hidePreviewFeedback",!0,{expires:1e3,path:"/"}),$feedbackCloser.trigger("click")})},_getPreviewTypes=function(){var options=[];return _(previewTypes).forEach(function(_previewLabel,_previewType){options.push({value:_previewType,label:_previewLabel,selected:previewType===_previewType})}),options},_setupViewSelector=function(){$("select.preview-type-selector").on("change",function(){var _previewType=$(this),value=_previewType.val();_setPreviewType(value),$("."+value+"-device-selector").trigger("change")}).select2({minimumResultsForSearch:-1})},_adaptFrameSize=function(){var $previewContainer=$(".preview-container"),$iframe=function(){var _iframe=$previewContainer.find("iframe");
return _iframe.height(""),_iframe}(),contentHeight=$iframe.contents().outerHeight(),containerHeight=$previewContainer.innerHeight();"standard"!==previewType?containerHeight>contentHeight&&(contentHeight=containerHeight):$previewContainer.height(contentHeight+10),$iframe.height(contentHeight)},_updateStandardPreviewSize=function(height){var $selector=$(".standard-device-selector"),values=($selector.val()?$selector.val().split(","):"")||[$window.width().toString()],valueStr=values.join(",");values[1]=height||values[1]||"1200",$selector.val(valueStr).data("value",valueStr)},_initConsole=function(){var $body=$console.find(".preview-console-body"),$listing=$body.find("ul"),$closer=$console.find(".preview-console-closer");
$console.off("updateConsole").on("updateConsole",function(event,type,message){var timer=new Date,logTime=[strPad(timer.getHours(),2,"0","STR_PAD_LEFT"),strPad(timer.getMinutes(),2,"0","STR_PAD_LEFT"),strPad(timer.getSeconds(),2,"0","STR_PAD_LEFT")].join(":"),msgStr='<span class="log-time">'+strPad(logTime,12," ")+'</span> <span class="log-type">'+strPad(type,18," ")+'</span> <span class="log-message">'+strPad(message,18," ")+"</span>";$listing.append("<li><pre>"+msgStr+"</pre></li>"),$body.is(":visible")?$listing.scrollTop(1e4):$body.slideDown("slow",function(){$closer.show(),$listing.scrollTop(1e4)})}),$closer.on("click",function(){$body.slideUp("slow",function(){$closer.hide()
})})},show=function(){$.ajax({url:itemUri,dataType:"html"}).done(function(data){$(".preview-item-container").html(data)}),overlay[0].style.display="block",overlay.height("100%"),overlay.find("select:visible").trigger("change"),_scale(),_positionPreview()},init=function(_itemUri){if(!_itemUri||0===_itemUri.length)throw new TypeError("Wrong URI");return $(".preview-overlay").remove(),container=null,overlay=$(previewTpl({mobileDevices:_getDeviceSelectorData("mobile"),desktopDevices:_getDeviceSelectorData("desktop"),previewTypes:_getPreviewTypes(),previewType:previewType})),$body.append(overlay),previewContainerMaxWidth=parseInt($(".preview-container").css("max-width"),10),$feedbackBox=overlay.find(".preview-message-box"),$.cookie("hidePreviewFeedback")&&$feedbackBox.hide(),$console=overlay.find("#preview-console"),_initConsole(),_updateStandardPreviewSize(),_setupTypeDependantElements(),_setupDeviceSelectors(),_setupOrientationSelectors(),_setupViewSelector(),_setupClosers(),_computeScaleFactor(),_setPreviewType(previewType),_setOrientation(orientation),$window.on("resize orientationchange",function(){screenSize={width:$window.innerWidth(),height:$window.innerHeight()},_updateStandardPreviewSize(),_computeScaleFactor(),_scale()
}),itemUri=_itemUri,overlay};return{init:init,show:show}}),define("taoItems/controller/items/action",["layout/actions/binder","uri","jquery","context","taoItems/preview/preview","helpers"],function(binder,uri,$,context,preview,helpers){binder.register("itemPreview",function(actionContext){preview.init(helpers._url("forwardMe","ItemPreview",context.shownExtension,{uri:actionContext.id})),preview.show()})}),define("taoItems/controller/items/edit",["module","layout/actions","jquery","helpers","ui/lock","ui/feedback","i18n"],function(module,actions,$,helpers,lock){var editItemController={start:function(){var config=module.config(),previewAction=(!!config.isPreviewEnabled,!!config.isAuthoringEnabled,actions.getBy("item-preview")),authoringAction=actions.getBy("item-authoring");
previewAction&&(previewAction.state.disabled=!config.isPreviewEnabled),authoringAction&&(authoringAction.state.disabled=!config.isAuthoringEnabled),actions.updateState(),$("#lock-box").each(function(){lock($(this)).register()})}};return editItemController}),define("serviceApi/ServiceApi",["jquery","urlParser","iframeResizer"],function($,UrlParser){function ServiceApi(baseUrl,parameters,serviceCallId,stateStorage,userService){this.baseUrl=baseUrl,this.parameters=parameters,this.connected=!1,this.serviceCallId=serviceCallId,this.state=stateStorage,this.userService=userService,this.onFinishCallback,this.onKillCallback,this.onDisplayChangeCallback}return ServiceApi.SIG_SUCCESS=0,ServiceApi.SIG_ERROR=1,ServiceApi.prototype.loadInto=function(frame,connected){var self=this,$frame=$(frame),callUrl=this.getCallUrl(),isCORSAllowed=new UrlParser(callUrl).checkCORS();
$frame.on("load",function(){$(document).on("serviceready",function(){self.connect(frame,function(){$(document).off("serviceready"),"function"==typeof connected&&connected()})}),isCORSAllowed===!0&&(frame.contentWindow.__knownParent__=!0)}),$frame.attr("src",callUrl)},ServiceApi.prototype.connect=function(frame,connected){this.connected===!1&&frame.contentWindow&&"function"==typeof frame.contentWindow.onServiceApiReady&&(frame.contentWindow.onServiceApiReady(this),this.connected=!0,"function"==typeof connected&&connected())},ServiceApi.prototype.getCallUrl=function(){var params=this.parameters||{};return params.serviceCallId=this.serviceCallId,this.baseUrl+"?"+$.param(params)
},ServiceApi.prototype.getUserPropertyValues=function(property,callback){this.userService.get(property,callback)},ServiceApi.prototype.getServiceCallId=function(){return this.serviceCallId},ServiceApi.prototype.getState=function(){return this.state.get()},ServiceApi.prototype.setState=function(state,callback){return this.state.set(state,callback)},ServiceApi.prototype.getParameter=function(identifier){return"undefined"!=typeof this.parameters[identifier]?this.parameters[identifier]:null},ServiceApi.prototype.onFinish=function(callback){this.onFinishCallback=callback},ServiceApi.prototype.onKill=function(callback){this.onKillCallback=callback},ServiceApi.prototype.kill=function(callback){"function"==typeof this.onKillCallback?this.onKillCallback(callback):callback(0)
},ServiceApi.prototype.finish=function(valueArray){"function"==typeof this.onFinishCallback&&this.onFinishCallback(valueArray)},ServiceApi}),define("serviceApi/PseudoStorage",[],function(){function PseudoStorage(){}return PseudoStorage.prototype.get=function(callback){return"function"==typeof callback&&callback(null),null},PseudoStorage.prototype.set=function(state,callback){"function"==typeof callback&&callback()},PseudoStorage}),define("serviceApi/UserInfoService",["jquery"],function($){function UserInfoService(requestUrl,data){this.data=data,this.requestUrl=requestUrl}return UserInfoService.prototype.get=function(property,callback){this.data.hasOwnProperty(property)?"function"==typeof callback&&callback(this.data[property]):$.ajax({url:this.requestUrl,data:{property:property},type:"post",dataType:"json",success:function(service,callback){return function(r){for(key in r.data)service.data[key]=r.data[key];
"function"==typeof callback&&callback(service.data[property])}}(this,callback)})},UserInfoService}),define("taoItems/runtime/ItemServiceImpl",["jquery"],function($){function ItemServiceImpl(data){this.itemId=data.itemId,this.serviceApi=data.serviceApi,this.resultApi=data.resultApi||null,this.params=data.params||{},this.responses={},this.scores={},this.events={},this.connected=!1;var rawstate=this.serviceApi.getState(),state="undefined"==typeof rawstate||null===rawstate?{}:$.parseJSON(rawstate);this.stateVariables="object"==typeof state?state:{},this.beforeFinishCallbacks=[]}return ItemServiceImpl.prototype.connect=function(frame){this.connected===!1&&frame.contentWindow&&(frame.contentWindow.itemApi=this,"function"==typeof frame.contentWindow.onItemApiReady&&(frame.contentWindow.onItemApiReady(this),this.connected=!0))
},ItemServiceImpl.prototype.saveResponses=function(valueArray){for(var attrname in valueArray)this.responses[attrname]=valueArray[attrname]},ItemServiceImpl.prototype.traceEvents=function(eventArray){for(var attrname in eventArray)this.events[attrname]=eventArray[attrname]},ItemServiceImpl.prototype.saveScores=function(valueArray){for(var attrname in valueArray)this.scores[attrname]=valueArray[attrname]},ItemServiceImpl.prototype.getUserPropertyValues=function(property,callback){this.serviceApi.getUserPropertyValues(property,callback)},ItemServiceImpl.prototype.beforeFinish=function(callback){this.beforeFinishCallbacks.push(callback)},ItemServiceImpl.prototype.finish=function(){for(var self=this,i=0;i<this.beforeFinishCallbacks.length;i++)this.beforeFinishCallbacks[i]();
this.submit(function(){self.serviceApi.finish()})},ItemServiceImpl.prototype.submit=function(after){var self=this;this.serviceApi.setState(JSON.stringify(self.stateVariables),function(){self.resultApi?self.resultApi.submitItemVariables(self.itemId,self.serviceApi.getServiceCallId(),self.responses,self.scores,self.events,self.params,after):after()})},ItemServiceImpl.prototype.onKill=function(callback){this.serviceApi.onKill(callback)},ItemServiceImpl.prototype.getVariable=function(identifier,callback){"function"==typeof callback&&callback(this.stateVariables[identifier]||null)},ItemServiceImpl.prototype.setVariable=function(identifier,value){this.stateVariables[identifier]=value,this.serviceApi.setState(JSON.stringify(this.stateVariables))
},ItemServiceImpl}),define("taoItems/preview/preview-console",["jquery"],function($){function unserializeUrl(params){var data={},hashes=params.split("&");for(var i in hashes)if("string"==typeof hashes[i]){var hash=hashes[i].split("=");if(2==hash.length)if(/\[\]$/.test(hash[0])){var key=hash[0].replace(/\[\]$/,"");"undefined"==typeof data[key]&&(data[key]=[]),data[key].push(hash[1])}else data[hash[0]]=hash[1]}return data}return{setup:function(){var timer=new Date,$previewConsole=$("#preview-console",window.top.document),$consoleCtrls=$(".console-control",$previewConsole),$consoleContent=$(".console-content",$previewConsole),$consoleContentList=$(".console-content > ul",$previewConsole);
$previewConsole.bind("updateConsole",function(event,type,message){var hour=timer.getHours(),min=timer.getMinutes(),sec=timer.getSeconds(),logTime=(hour>10?hour:"0"+hour)+":"+(min>10?min:"0"+min)+":"+(sec>10?sec:"0"+sec);$consoleContentList.append("<li><b>["+logTime+"] "+type+"</b>: "+message+"</li>")}),$(".ui-icon-circle-close",$consoleCtrls).on("click",function(event){event.preventDefault(),$previewConsole.hide()}),$(".ui-icon-trash",$consoleCtrls).on("click",function(event){event.preventDefault(),$consoleContentList.empty()}),$(".toggler",$consoleCtrls).on("click",function(event){event.preventDefault(),$consoleContent.toggle(),$(this).toggleClass("ui-icon-circle-minus").toggleClass("ui-icon-circle-plus")
}),$("body").ajaxSuccess(function(event,request,settings){if(/LegacyPreviewApi/.test(settings.url)){var message="";if(/save$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));for(var key in data)"token"!==key&&(message+="<br />"+key+" = "+data[key]);""!==message&&(message+="<br />",$previewConsole.trigger("updateConsole",["push data",message]))}else if(/traceEvents$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));if(data.events){for(var index in data.events)try{var eventData=$.parseJSON(data.events[index]);message+="<br />"+eventData.type+" on element "+eventData.name,"noID"!==eventData.id&&(message+="[id="+eventData.id+"]")
}catch(exp){}message+="<br />",$previewConsole.trigger("updateConsole",["trace events",message])}}else if(/saveContext$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));for(key in data)"token"!==key&&(message+="<br />"+key+" = "+data[key]);message+="<br />",$previewConsole.trigger("updateConsole",["save context",message])}else if(/retrieveContext$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));for(key in data)"token"!==key&&(message+="<br />"+key+" = "+data[key]);message+="<br />",$previewConsole.trigger("updateConsole",["retrieved context",message])}else if(/evaluate$/.test(settings.url)){var data=unserializeUrl(decodeURIComponent(settings.data));
if(data.data){try{var matchingDataList=$.parseJSON(data.data);for(key in matchingDataList)message+="<br />"+matchingDataList[key].identifier+" = "+matchingDataList[key].value}catch(exp){}message+="<br />",$previewConsole.trigger("updateConsole",["sent answers",message])}}else message="<br />"+settings.type+" "+settings.url+" ? "+decodeURIComponent(settings.data)+" => "+request.responseText,$previewConsole.trigger("updateConsole",["remote request",message])}})}}}),define("taoItems/controller/preview/itemRunner",["module","jquery","lodash","serviceApi/ServiceApi","serviceApi/PseudoStorage","serviceApi/UserInfoService","taoItems/runtime/ItemServiceImpl","taoItems/preview/preview-console","urlParser","iframeResizer"],function(module,$,_,ServiceApi,PseudoStorage,UserInfoService,ItemServiceImpl,previewConsole,UrlParser,iframeResizer){var previewItemRunner={start:function(options){var conf=_.merge(module.config(),options||{});
if(conf.previewUrl){previewConsole.setup();var resultServer=_.defaults(conf.resultServer,{module:"taoResultServer/ResultServerApi",endpoint:"",params:{}});require([resultServer.module],function(ResultServerApi){var resultServerApi=new ResultServerApi(resultServer.endpoint,resultServer.params),serviceApi=new ServiceApi(conf.previewUrl,{},"preview",new PseudoStorage,new UserInfoService(conf.userInfoServiceRequestUrl,{})),itemApi=new ItemServiceImpl({serviceApi:serviceApi,resultApi:resultServerApi}),callUrl=new UrlParser(serviceApi.getCallUrl()),isCORSAllowed=callUrl.checkCORS();callUrl.addParam("clientConfigUrl",conf.clientConfigUrl);var $frame=$("#preview-container");
iframeResizer.autoHeight($frame,"body",10),$frame.on("load",function(){var frame=this;itemApi.connect(frame),isCORSAllowed===!0&&(frame.contentWindow.__knownParent__=!0),$(document).on("itemready",function(){itemApi.connect(frame)})}),$("#preview-container").attr("src",callUrl.getUrl()),$("#finishButton").click(function(){itemApi.finish()})})}}};return previewItemRunner}),define("taoItems/controller/runtime/itemRunner",["jquery","lodash","iframeResizer","iframeNotifier","urlParser"],function($,_,iframeResizer,iframeNotifier,UrlParser){var itemRunner={start:function(options){var $frame=$('<iframe id="item-container" class="toolframe" frameborder="0" style="width:100%;height:100%;overflow:hidden" scrolling="no"></iframe>');
$frame.appendTo("body");var itemId=options.itemId,itemPath=options.itemPath,resultServer=_.defaults(options.resultServer,{module:"taoResultServer/ResultServerApi",params:{}}),itemService=_.defaults(options.itemService,{module:"taoItems/runtime/ItemServiceImpl",params:{}}),clientConfigUrl=options.clientConfigUrl,timeout=options.timeout||30;require([itemService.module,resultServer.module],function(ItemService,ResultServerApi){var resultServerApi=new ResultServerApi(resultServer.endpoint,resultServer.params);window.onServiceApiReady=function(serviceApi){var itemApi=new ItemService(_.merge({serviceApi:serviceApi,itemId:itemId,resultApi:resultServerApi},{params:itemService.params})),itemUrl=new UrlParser(itemPath),isCORSAllowed=itemUrl.checkCORS();
itemUrl.addParam("clientConfigUrl",clientConfigUrl),itemUrl.addParam("timeout",timeout),iframeResizer.autoHeight($frame,"body",10),$(document).on("itemloaded",function(){iframeNotifier.parent("serviceloaded")}),$(document).on("itemready",function(){itemApi.connect($frame[0])}),$frame.on("load",function(){itemApi.connect($frame[0]),isCORSAllowed===!0&&(this.contentWindow.__knownParent__=!0)}),$frame.attr("src",itemUrl.getUrl())},_.defer(function(){iframeNotifier.parent("serviceready")})})}};return itemRunner});
//# sourceMappingURL=routes.js
//# sourceMappingURL=routes.js.map